(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,52683,e=>{"use strict";e.i(47167);var t=e.i(43476),s=e.i(71645);let r="https://petigen.zacchen.win";async function a(e,t){let s=`${r}${e}`,a=await fetch(s,{...t,headers:{"Content-Type":"application/json",...t?.headers}});if(!a.ok)throw Error(await a.text()||`API error: ${a.status}`);return a.json()}let l=async(e,t,s,a,l,n)=>{let i=await fetch(`${r}/api/upload/init`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:e,file_name:t,file_size:s,total_chunks:a,exhibit_number:l||null,exhibit_title:n||null})});if(!i.ok)throw Error(`Init upload failed: ${i.status}`);return i.json()},n=async(e,t,s)=>{let a=new FormData;a.append("chunk",s);let l=await fetch(`${r}/api/upload/chunk/${e}/${t}`,{method:"POST",body:a});if(!l.ok)throw Error(`Chunk upload failed: ${l.status}`);return l.json()},i=async e=>{let t=await fetch(`${r}/api/upload/complete/${e}`,{method:"POST"});if(!t.ok)throw Error(`Complete upload failed: ${t.status}`);return t.json()},o=async e=>{await fetch(`${r}/api/upload/cancel/${e}`,{method:"DELETE"})};async function c(e,t,s,r,a){let c=Math.ceil(t.size/5242880),{upload_id:d}=await l(e,t.name,t.size,c,s,r);try{for(let e=0;e<c;e++){let s=5242880*e,r=Math.min(s+5242880,t.size),l=t.slice(s,r);await n(d,e,l);let i=Math.round((e+1)/c*100);a?.(i)}return await i(d)}catch(e){try{await o(d)}catch{}throw e}}let d=e=>a(`/api/l1-summary/${e}`),x=(e,t)=>{let s=t?`?page=${t}`:"";return a(`/api/highlight/${e}${s}`)},u=e=>a(`/api/highlight/progress/${e}`);function m(e){let{fetcher:t,shouldContinue:r,interval:a=2e3,errorRetryInterval:l=5e3,maxErrorCount:n=3,maxDuration:i,enabled:o=!1,onSuccess:c,onError:d,onTimeout:x,onMaxErrors:u}=e,[m,h]=(0,s.useState)(null),[p,g]=(0,s.useState)(null),[b,f]=(0,s.useState)(!1),[j,y]=(0,s.useState)(0),v=(0,s.useRef)(!1),N=(0,s.useRef)(0),w=(0,s.useRef)(null),k=(0,s.useRef)(null),C=(0,s.useRef)(null),L=(0,s.useRef)(!0),S=(0,s.useRef)(c),$=(0,s.useRef)(d),_=(0,s.useRef)(x),M=(0,s.useRef)(u),E=(0,s.useRef)(t),B=(0,s.useRef)(r);(0,s.useEffect)(()=>{S.current=c,$.current=d,_.current=x,M.current=u,E.current=t,B.current=r},[c,d,x,u,t,r]);let W=(0,s.useCallback)(()=>{w.current&&(clearTimeout(w.current),w.current=null),k.current&&(clearTimeout(k.current),k.current=null)},[]),z=(0,s.useCallback)(()=>{v.current=!1,f(!1),W(),C.current=null},[W]),R=(0,s.useCallback)(()=>{z(),h(null),g(null),y(0),N.current=0},[z]),O=(0,s.useCallback)(async()=>{if(v.current&&L.current)try{let e=await E.current();if(!L.current)return;N.current=0,y(0),g(null),h(e),S.current?.(e),B.current(e)&&v.current?w.current=setTimeout(O,a):z()}catch(s){if(!L.current)return;let e=s instanceof Error?s:Error(String(s));g(e),N.current+=1;let t=N.current;y(t),$.current?.(e),t>=n?(M.current?.(),z()):v.current&&(w.current=setTimeout(O,l))}},[a,l,n,z]),P=(0,s.useCallback)(()=>{v.current||(N.current=0,y(0),g(null),v.current=!0,f(!0),C.current=Date.now(),i&&(k.current=setTimeout(()=>{L.current&&v.current&&(_.current?.(),z())},i)),O())},[O,i,z]);return(0,s.useEffect)(()=>{o&&P()},[o]),(0,s.useEffect)(()=>(L.current=!0,()=>{L.current=!1,W()}),[W]),{data:m,error:p,isPolling:b,errorCount:j,start:P,stop:z,reset:R}}let h=["A","B","C","D","E","F","G","H"],p=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),g=()=>(0,t.jsx)("svg",{className:"w-8 h-8",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),b=()=>(0,t.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),f=()=>(0,t.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M6 18L18 6M6 6l12 12"})}),j=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),y=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})});function v({projectId:e,documents:r,onUploadComplete:a,onError:l,onSuccess:n}){let[i,o]=(0,s.useState)([]),[d,x]=(0,s.useState)(!1),[u,m]=(0,s.useState)("A"),[v,N]=(0,s.useState)(!1),w=(0,s.useRef)(null),k=(0,s.useMemo)(()=>r.map(e=>{let t=e.exhibit_number||"N/A",s=t.split("-")[0]||"A";return{id:e.id,fileName:e.file_name,exhibitNumber:t,exhibitFolder:s,status:"completed",progress:100,isUploading:!1}}),[r]),C=(0,s.useMemo)(()=>i.map(e=>({id:e.id,fileName:e.file.name,exhibitNumber:e.exhibitNumber,exhibitFolder:e.exhibitFolder,status:e.status,progress:e.progress,isUploading:!0,error:e.error})),[i]),L=(0,s.useMemo)(()=>{let e=[...k],t=new Set(k.map(e=>e.exhibitNumber));for(let s of C)t.has(s.exhibitNumber)||e.push(s);return e},[k,C]),S=(0,s.useMemo)(()=>{let e={};return h.forEach(t=>{e[t]=L.filter(e=>e.exhibitFolder===t)}),e},[L]),$=(0,s.useCallback)(e=>{let t=L.filter(t=>t.exhibitFolder===e);return 0===t.length?1:Math.max(...t.map(e=>{let t=e.exhibitNumber.match(/-(\d+)$/);return t?parseInt(t[1]):0}))+1},[L]),_=v?"uploading":i.some(e=>"completed"===e.status)?"completed":"idle",M=(0,s.useCallback)(e=>{if(!e||0===e.length)return;let t=[],s=$(u);for(let r=0;r<e.length;r++){let a=e[r];(["application/pdf","image/png","image/jpeg","image/jpg","image/tiff"].includes(a.type)||a.name.match(/\.(pdf|png|jpg|jpeg|tiff?)$/i))&&(t.push({id:`${Date.now()}-${r}`,file:a,exhibitNumber:`${u}-${s}`,exhibitFolder:u,status:"pending",progress:0}),s++)}t.length>0&&o(e=>[...e,...t])},[u,$]),E=async()=>{let t=i.filter(e=>"pending"===e.status);if(0===t.length)return;N(!0);let s=0,r=0;for(let a of t){let t=a.id;o(e=>e.map(e=>e.id===t?{...e,status:"uploading",progress:0}:e));try{await c(e,a.file,a.exhibitNumber,a.file.name.replace(/\.[^/.]+$/,""),e=>{o(s=>s.map(s=>s.id===t?{...s,progress:e}:s))}),o(e=>e.map(e=>e.id===t?{...e,status:"completed",progress:100}:e)),s++}catch(e){o(s=>s.map(s=>s.id===t?{...s,status:"failed",error:e.message}:s)),r++}}N(!1),s>0&&(n(`${s} 个文件上传成功`),a()),r>0&&l(`${r} 个文件上传失败`)},B=S[u]||[],W=i.filter(e=>"pending"===e.status).length,z=L.length;return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600",children:(0,t.jsx)(p,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:"上传模块"}),z>0&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[z," 个文件"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[W>0&&(0,t.jsxs)("button",{onClick:E,disabled:v,className:"flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[(0,t.jsx)(p,{}),"上传 (",W,")"]}),(0,t.jsx)(({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:"等待上传"},uploading:{bg:"bg-blue-100",text:"text-blue-700",label:"上传中"},completed:{bg:"bg-green-100",text:"text-green-700",label:"已完成"}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},{status:_})]})]})}),(0,t.jsxs)("div",{className:"flex",style:{minHeight:"300px"},children:[(0,t.jsxs)("div",{className:"w-64 border-r border-gray-200 flex flex-col",children:[(0,t.jsx)("div",{className:"px-2 py-2 border-b border-gray-100 bg-gray-50",children:(0,t.jsx)("div",{className:"flex flex-wrap gap-1",children:h.map(e=>{let s=S[e]?.length||0;return(0,t.jsxs)("button",{onClick:()=>m(e),className:`relative px-3 py-1.5 text-xs font-medium rounded transition-colors ${u===e?"bg-blue-600 text-white":"bg-white text-gray-700 hover:bg-gray-100 border border-gray-200"}`,children:[e,s>0&&(0,t.jsx)("span",{className:`absolute -top-1 -right-1 w-4 h-4 text-xs rounded-full flex items-center justify-center ${u===e?"bg-white text-blue-600":"bg-blue-500 text-white"}`,children:s})]},e)})})}),(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-600",children:["Exhibit ",u," (",B.length,")"]}),B.length>0&&(0,t.jsx)("button",{onClick:()=>{o(e=>e.filter(e=>e.exhibitFolder!==u))},className:"text-xs text-gray-400 hover:text-red-500 transition-colors",children:"清除"})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===B.length?(0,t.jsxs)("div",{className:"p-4 text-center text-xs text-gray-400",children:["暂无文件",(0,t.jsx)("p",{className:"mt-1",children:"拖拽或点击右侧区域上传"})]}):(0,t.jsx)("div",{className:"py-1",children:B.map(e=>(0,t.jsxs)("div",{className:`flex items-center gap-2 px-3 py-2 border-b border-gray-50 ${"completed"===e.status?"bg-green-50":"failed"===e.status?"bg-red-50":"uploading"===e.status?"bg-blue-50":"hover:bg-gray-50"}`,children:[(0,t.jsx)("div",{className:"flex-shrink-0 w-4 h-4 flex items-center justify-center",children:"uploading"===e.status?(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}):"completed"===e.status?(0,t.jsx)("div",{className:"w-3 h-3 bg-green-500 rounded-full flex items-center justify-center",children:(0,t.jsx)(b,{})}):"failed"===e.status?(0,t.jsx)("div",{className:"w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white",children:(0,t.jsx)(f,{})}):(0,t.jsx)("div",{className:"text-gray-400",children:(0,t.jsx)(j,{})})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 truncate",children:e.exhibitNumber}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:e.fileName,children:e.fileName}),"uploading"===e.status&&(0,t.jsx)("div",{className:"mt-1 h-1 bg-gray-200 rounded-full overflow-hidden",children:(0,t.jsx)("div",{className:"h-full bg-blue-500 rounded-full transition-all duration-300",style:{width:`${e.progress}%`}})})]}),(0,t.jsx)("div",{className:"flex-shrink-0",children:"uploading"===e.status?(0,t.jsxs)("span",{className:"text-xs text-blue-600",children:[e.progress,"%"]}):"pending"===e.status&&e.isUploading?(0,t.jsx)("button",{onClick:()=>{var t;return t=e.id,void o(e=>e.filter(e=>e.id!==t))},className:"p-1 text-gray-400 hover:text-red-600 transition-colors",children:(0,t.jsx)(y,{})}):null})]},e.id))})})]}),(0,t.jsx)("div",{className:"flex-1 p-4 flex items-center justify-center",children:(0,t.jsxs)("div",{onDragOver:e=>{e.preventDefault(),x(!0)},onDragLeave:e=>{e.preventDefault(),x(!1)},onDrop:e=>{e.preventDefault(),x(!1),M(e.dataTransfer.files)},onClick:()=>w.current?.click(),className:`w-full h-full border-2 border-dashed rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all ${d?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-400 hover:bg-gray-50"}`,children:[(0,t.jsx)("input",{ref:w,type:"file",multiple:!0,accept:".pdf,.png,.jpg,.jpeg,.tiff,.tif",onChange:e=>M(e.target.files),className:"hidden"}),(0,t.jsx)("div",{className:`mb-3 ${d?"text-blue-500":"text-gray-400"}`,children:(0,t.jsx)(g,{})}),(0,t.jsx)("p",{className:"text-sm font-medium text-gray-700",children:"拖拽文件到这里，或点击上传"}),(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"支持 PDF、JPG、PNG"}),(0,t.jsxs)("p",{className:"text-xs text-blue-600 mt-3 font-medium",children:["当前目标: Exhibit ",u]})]})})]})]})}function N({url:e,onMessage:t,onComplete:r,onError:a,autoConnect:l=!1}){let[n,i]=(0,s.useState)(!1),[o,c]=(0,s.useState)(null),d=(0,s.useRef)(null),x=(0,s.useRef)(!0),u=(0,s.useRef)(t),m=(0,s.useRef)(r),h=(0,s.useRef)(a);(0,s.useEffect)(()=>{u.current=t,m.current=r,h.current=a},[t,r,a]);let p=(0,s.useCallback)(()=>{d.current&&(d.current.close(),d.current=null),x.current&&i(!1)},[]),g=(0,s.useCallback)(()=>{if(!e)return;d.current&&d.current.close();let t=new EventSource(e);d.current=t,t.onopen=()=>{x.current&&i(!0)},t.onmessage=e=>{if(x.current)try{let t=JSON.parse(e.data);c(t),u.current?.(t)}catch(e){console.error("[useSSE] Failed to parse message:",e)}},t.addEventListener("progress",e=>{if(x.current)try{let t=JSON.parse(e.data);c(t),u.current?.(t)}catch(e){console.error("[useSSE] Failed to parse progress event:",e)}}),t.addEventListener("complete",e=>{if(x.current)try{let t=JSON.parse(e.data);c(t),m.current?.(t),p()}catch(e){console.error("[useSSE] Failed to parse complete event:",e)}}),t.onerror=e=>{x.current&&(console.error("[useSSE] Connection error:",e),h.current?.(e),i(!1))}},[e,p]);return(0,s.useEffect)(()=>{l&&e&&g()},[l,e,g]),(0,s.useEffect)(()=>(x.current=!0,()=>{x.current=!1,d.current&&(d.current.close(),d.current=null)}),[]),(0,s.useEffect)(()=>{!e&&d.current&&p()},[e,p]),{isConnected:n,lastData:o,connect:g,disconnect:p}}let w="undefined"!=typeof EventSource,k=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"})}),C=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),L=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),S=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),$=({status:e})=>{switch(e){case"pending":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-gray-300 flex-shrink-0",title:"待处理"});case"queued":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-yellow-400 flex-shrink-0",title:"队列中"});case"processing":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse flex-shrink-0",title:"处理中"});case"completed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-green-500 flex-shrink-0",title:"完成"});case"failed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-red-500 flex-shrink-0",title:"失败"})}};function _({projectId:e,documents:l,onOCRComplete:n,onSuccess:i,onError:o,modelsReady:c=!0}){let d,[x,u]=(0,s.useState)([]),[h,p]=(0,s.useState)(null),[g,b]=(0,s.useState)(""),[f,j]=(0,s.useState)(!1),[y,v]=(0,s.useState)(!1),[_,M]=(0,s.useState)(null),E=e?(d=e,`${r}/api/ocr/stream/${d}`):null,B=(0,s.useCallback)(e=>{e.current_processing?M({documentId:e.current_processing.document_id,fileName:e.current_processing.file_name,currentPage:e.current_processing.current_page,totalPages:e.current_processing.total_pages}):M(null),u(t=>t.map(t=>{let s=e.documents?.find(e=>e.id===t.id);return s?{...t,status:s.ocr_status}:t}))},[]),W=(0,s.useCallback)(e=>{v(!1),M(null),n(),e.failed>0?o(`OCR 完成: ${e.completed} 成功, ${e.failed} 失败`):e.completed>0&&i(`OCR 完成: ${e.completed} 个文档已处理`)},[n,o,i]),{isConnected:z,connect:R,disconnect:O}=N({url:w?E:null,onMessage:B,onComplete:W,onError:e=>{console.error("[OCR SSE] Connection error:",e)}}),{isPolling:P,errorCount:F,start:T,stop:D}=m({fetcher:()=>{let t;return t=e,a(`/api/ocr/progress/${t}`)},shouldContinue:e=>e.processing>0||e.pending>0||e.queued>0,interval:2e3,errorRetryInterval:5e3,maxErrorCount:3,maxDuration:18e5,enabled:!1,onSuccess:e=>{B(e),0===e.processing&&0===e.pending&&0===e.queued&&W(e)},onError:e=>{console.error("Failed to get OCR progress:",e)},onMaxErrors:()=>{v(!1),o("无法连接后端服务，请检查后端是否运行"),u(e=>e.map(e=>"processing"===e.status||"queued"===e.status?{...e,status:"pending"}:e))},onTimeout:()=>{v(!1),o("OCR 处理超时，请检查后端状态"),u(e=>e.map(e=>"processing"===e.status||"queued"===e.status?{...e,status:"pending"}:e))}}),H=(0,s.useCallback)(()=>{v(!0),w?R():T()},[R,T]);(0,s.useCallback)(()=>{v(!1),w?O():D()},[O,D]),(0,s.useEffect)(()=>{let e=l.map(e=>({id:e.id,fileName:e.file_name,exhibitNumber:e.exhibit_number||"N/A",status:e.ocr_status||"pending",ocrText:e.ocr_text}));if(u(e),!h){let t=e.find(e=>"completed"===e.status);t&&(p(t.id),b(t.ocrText||""))}},[l,h]);let q=y||x.some(e=>"processing"===e.status)?"processing":x.length>0&&x.every(e=>"completed"===e.status)?"completed":"idle",A=x.filter(e=>"pending"===e.status).length,V=x.filter(e=>"completed"===e.status).length,I=async e=>{try{let t;u(t=>t.map(t=>t.id===e?{...t,status:"processing"}:t)),await (t=e,a(`/api/ocr/${t}`,{method:"POST"})),H()}catch(t){console.error("OCR failed:",t),o(t instanceof Error&&t.message.includes("fetch")?"无法连接后端服务":"OCR 启动失败"),u(t=>t.map(t=>t.id===e?{...t,status:"pending"}:t))}},J=async()=>{if(0!==A)try{let t;u(e=>e.map(e=>"pending"===e.status?{...e,status:"queued"}:e)),await (t=e,a(`/api/ocr/batch/${t}`,{method:"POST"})),i("OCR 处理已启动"),H()}catch(e){console.error("Batch OCR failed:",e),o(e instanceof Error&&e.message.includes("fetch")?"无法连接后端服务":"批量 OCR 启动失败"),u(e=>e.map(e=>"queued"===e.status?{...e,status:"pending"}:e))}},U=e=>{p(e.id),b(e.ocrText||"")},K=x.find(e=>e.id===h);return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600",children:(0,t.jsx)(k,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:"OCR 模块"}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[V,"/",x.length," 已完成"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("button",{onClick:J,disabled:0===A||y||!c,className:"flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-xs font-medium rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:c?void 0:"模型加载中...",children:[(0,t.jsx)(C,{}),c?"全部开始":"模型加载中..."]}),(0,t.jsx)(({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:"等待处理"},processing:{bg:"bg-blue-100",text:"text-blue-700",label:"处理中"},completed:{bg:"bg-green-100",text:"text-green-700",label:"已完成"}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},{status:q})]})]})}),(0,t.jsxs)("div",{className:"flex",style:{height:"500px"},children:[(0,t.jsxs)("div",{className:`border-r border-gray-200 flex flex-col transition-all duration-300 ${f?"w-10":"w-64"}`,children:[(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[!f&&(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:"文件列表"}),(0,t.jsx)("button",{onClick:()=>j(!f),className:"p-1 hover:bg-gray-200 rounded transition-colors",title:f?"展开":"折叠",children:f?(0,t.jsx)(S,{}):(0,t.jsx)(L,{})})]}),f?(0,t.jsx)("div",{className:"flex-1 overflow-y-auto py-1",children:x.map(e=>(0,t.jsx)("div",{onClick:()=>"completed"===e.status&&U(e),className:`flex items-center justify-center py-2 cursor-pointer transition-colors ${h===e.id?"bg-purple-50":"hover:bg-gray-50"}`,title:`${e.exhibitNumber}: ${e.fileName}`,children:(0,t.jsx)($,{status:e.status})},e.id))}):(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===x.length?(0,t.jsx)("div",{className:"p-4 text-center text-xs text-gray-400",children:"暂无文件"}):(0,t.jsx)("div",{className:"py-1",children:x.map(e=>(0,t.jsxs)("div",{onClick:()=>"completed"===e.status&&U(e),className:`px-3 py-2 cursor-pointer transition-colors ${h===e.id?"bg-purple-50 border-r-2 border-purple-500":"hover:bg-gray-50"} ${"completed"!==e.status?"opacity-60":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)($,{status:e.status}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 truncate",children:e.exhibitNumber}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:e.fileName,children:e.fileName})]}),"pending"===e.status&&!y&&c&&(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),I(e.id)},className:"px-1.5 py-0.5 text-xs text-purple-600 hover:bg-purple-100 rounded transition-colors",children:"开始"})]}),_?.documentId===e.id&&_.totalPages>0&&(0,t.jsxs)("div",{className:"mt-2",children:[(0,t.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 mb-1",children:[(0,t.jsxs)("span",{children:["第 ",_.currentPage,"/",_.totalPages," 页"]}),(0,t.jsxs)("span",{children:[Math.round(_.currentPage/_.totalPages*100),"%"]})]}),(0,t.jsx)("div",{className:"h-1.5 bg-gray-200 rounded-full overflow-hidden",children:(0,t.jsx)("div",{className:"h-full bg-purple-500 transition-all duration-300",style:{width:`${_.currentPage/_.totalPages*100}%`}})})]})]},e.id))})})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,t.jsxs)("div",{className:"px-4 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:K?`OCR 结果 - ${K.exhibitNumber}: ${K.fileName}`:"OCR 结果预览"}),g&&(0,t.jsx)("button",{onClick:async()=>{try{await navigator.clipboard.writeText(g)}catch(e){console.error("Failed to copy:",e)}},className:"text-xs text-gray-500 hover:text-gray-700 px-2 py-1 hover:bg-gray-200 rounded transition-colors",children:"复制"})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-4 bg-white",children:g?(0,t.jsx)("div",{className:"prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap font-mono text-sm leading-relaxed",children:g}):(0,t.jsx)("div",{className:"h-full flex items-center justify-center text-gray-400",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,t.jsx)("p",{className:"text-sm",children:"选择一个已完成 OCR 的文件查看结果"})]})})})]})]})]})}let M=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),E=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),B=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),W=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"})}),z=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"})}),R={key_fact:"rgba(59, 130, 246, 0.3)",evidence:"rgba(16, 185, 129, 0.3)",timeline:"rgba(245, 158, 11, 0.3)",entity:"rgba(139, 92, 246, 0.3)",financial:"rgba(236, 72, 153, 0.3)",default:"rgba(251, 191, 36, 0.3)"};function O({documentId:e,pageCount:a=1,currentPage:l,onPageChange:n,selectedHighlightId:i}){let[o,c]=(0,s.useState)(1),d=l??o,u=e=>{n?n(e):c(e)},[m,h]=(0,s.useState)(a),[p,g]=(0,s.useState)(null),[b,f]=(0,s.useState)([]),[j,y]=(0,s.useState)(!1),[v,N]=(0,s.useState)(null),[w,k]=(0,s.useState)(100),[C,L]=(0,s.useState)(null),[S,$]=(0,s.useState)(null);return((0,s.useEffect)(()=>{if(i){let e=b.find(e=>e.id===i);e&&L(e)}},[i,b]),(0,s.useEffect)(()=>{if(!e){g(null),f([]);return}(async()=>{y(!0),N(null),$(null);try{var t,s;let a,l=(t=e,s=d,a="",`${r}/api/highlight/page/${t}/${s}/image${a}`);g(l);let n=await x(e,d);f(n.highlights||[])}catch(e){console.error("Failed to load page data:",e),N("无法加载页面"),g(null),f([])}finally{y(!1)}})()},[e,d]),(0,s.useEffect)(()=>{h(a)},[a]),(0,s.useEffect)(()=>{l||c(1),L(null)},[e,l]),e)?(0,t.jsxs)("div",{className:"h-full flex flex-col border border-gray-200 rounded-lg overflow-hidden bg-white",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("button",{onClick:()=>{k(e=>Math.max(e-25,50))},disabled:w<=50,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"缩小",children:(0,t.jsx)(z,{})}),(0,t.jsxs)("span",{className:"text-xs text-gray-600 min-w-[40px] text-center",children:[w,"%"]}),(0,t.jsx)("button",{onClick:()=>{k(e=>Math.min(e+25,200))},disabled:w>=200,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"放大",children:(0,t.jsx)(W,{})})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>{d>1&&(u(d-1),L(null))},disabled:d<=1,className:"p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,t.jsx)(M,{})}),(0,t.jsxs)("span",{className:"text-sm text-gray-700 min-w-[60px] text-center",children:[d," / ",m]}),(0,t.jsx)("button",{onClick:()=>{d<m&&(u(d+1),L(null))},disabled:d>=m,className:"p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,t.jsx)(E,{})})]}),(0,t.jsx)("button",{onClick:()=>{p&&window.open(p,"_blank")},className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded transition-colors",title:"下载当前页",children:(0,t.jsx)(B,{})})]}),(0,t.jsx)("div",{className:"flex-1 overflow-auto bg-gray-100 relative",children:j?(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-8 h-8 border-3 border-blue-500 border-t-transparent rounded-full animate-spin"})}):v?(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-sm text-red-500",children:v})}):p?(0,t.jsx)("div",{className:"min-h-full flex items-start justify-center p-4",children:(0,t.jsxs)("div",{className:"relative shadow-lg bg-white",style:{transform:`scale(${w/100})`,transformOrigin:"top center"},children:[(0,t.jsx)("img",{src:p,alt:`Page ${d}`,className:"block",style:{maxWidth:"none"},onLoad:e=>{let t=e.target;$({width:t.naturalWidth,height:t.naturalHeight})},onError:()=>N("图片加载失败")}),S&&b.map((e,s)=>{var r;let a,l,n;if(!e.bbox||null==e.bbox.x1)return null;let{x1:i,y1:o,x2:c,y2:d}=e.bbox,x=(a={x1:i||0,y1:o||0,x2:c||0,y2:d||0},l=S.width,n=S.height,{left:a.x1/1e3*l,top:a.y1/1e3*n,width:(a.x2-a.x1)/1e3*l,height:(a.y2-a.y1)/1e3*n});return x.width<=0||x.height<=0?null:(0,t.jsx)("div",{className:`absolute cursor-pointer transition-all ${C?.id===e.id?"ring-2 ring-blue-500":"hover:ring-2 hover:ring-blue-300"}`,style:{left:`${x.left}px`,top:`${x.top}px`,width:`${x.width}px`,height:`${x.height}px`,backgroundColor:(r=e.category)&&R[r.toLowerCase()]||R.default,borderRadius:"2px"},onClick:()=>L(e),title:e.text_content||"高光区域"},e.id||s)})]})}):(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"无法加载页面"})})}),C&&(0,t.jsx)("div",{className:"px-4 py-3 bg-blue-50 border-t border-blue-200",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[C.category&&(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs font-medium rounded bg-blue-100 text-blue-700",children:C.category_cn||C.category}),C.importance&&(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${"high"===C.importance?"bg-red-100 text-red-700":"medium"===C.importance?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-700"}`,children:"high"===C.importance?"高重要":"medium"===C.importance?"中等":"低"})]}),(0,t.jsx)("p",{className:"text-sm text-gray-800 line-clamp-2",children:C.text_content||"无文本内容"}),C.reason&&(0,t.jsxs)("p",{className:"text-xs text-gray-600 mt-1 line-clamp-1",children:[(0,t.jsx)("span",{className:"font-medium",children:"原因:"})," ",C.reason]})]}),(0,t.jsx)("button",{onClick:()=>L(null),className:"p-1 text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),b.length>0&&(0,t.jsxs)("div",{className:"px-3 py-1.5 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 text-center",children:["当前页 ",b.length," 个高光区域"]})]}):(0,t.jsx)("div",{className:"h-full flex items-center justify-center bg-gray-50 rounded-lg border border-gray-200",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:"选择文件查看预览"})]})})}let P="undefined"!=typeof EventSource,F=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),T=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),D=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),H=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),q=({status:e})=>{switch(e){case"not_started":case"pending":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-gray-300 flex-shrink-0",title:"待分析"});case"processing":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse flex-shrink-0",title:"分析中"});case"completed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-green-500 flex-shrink-0",title:"完成"});case"failed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-red-500 flex-shrink-0",title:"失败"})}};function A({projectId:e,documents:l,onHighlightComplete:n,onSuccess:i,onError:o,modelsReady:c=!0}){let d,[h,p]=(0,s.useState)([]),[g,b]=(0,s.useState)(null),[f,j]=(0,s.useState)(!1),[y,v]=(0,s.useState)(!1),[w,k]=(0,s.useState)(!1),[C,L]=(0,s.useState)([]),[S,$]=(0,s.useState)(!1),[_,M]=(0,s.useState)(1),[E,B]=(0,s.useState)(null),W=(0,s.useRef)(!1),z=(0,s.useRef)(!1),R=e?(d=e,`${r}/api/highlight/stream/${d}`):null,A=(0,s.useCallback)(e=>{p(t=>{let s=!1,r=t.map(t=>{let r=e.documents?.find(e=>e.id===t.id);if(r){let e=r.highlight_status||"pending";if(t.status!==e)return s=!0,{...t,status:e}}return t});return s?r:t})},[]),V=(0,s.useCallback)(e=>{k(!1),n(),e.failed>0?o(`高光分析完成: ${e.completed} 成功, ${e.failed} 失败`):e.completed>0&&i(`高光分析完成: ${e.completed} 个文档已处理`)},[n,o,i]),{isConnected:I,connect:J,disconnect:U}=N({url:P?R:null,onMessage:A,onComplete:V,onError:e=>{console.error("[Highlight SSE] Connection error:",e)}}),{isPolling:K,errorCount:G,start:Q,stop:Y}=m({fetcher:()=>u(e),shouldContinue:e=>e.processing>0||e.pending>0,interval:2e3,errorRetryInterval:5e3,maxErrorCount:3,maxDuration:18e5,enabled:!1,onSuccess:e=>{A(e),0===e.processing&&0===e.pending&&V(e)},onError:e=>{console.error("Failed to get highlight progress:",e)},onMaxErrors:()=>{k(!1),o("无法连接后端服务，请检查后端是否运行"),p(e=>e.map(e=>"processing"===e.status?{...e,status:"pending"}:e))},onTimeout:()=>{k(!1),o("高光分析处理超时，请检查后端状态"),p(e=>e.map(e=>"processing"===e.status?{...e,status:"pending"}:e))}}),Z=(0,s.useCallback)(()=>{k(!0),P?J():Q()},[J,Q]);(0,s.useCallback)(()=>{k(!1),P?U():Y()},[U,Y]);let X=(0,s.useMemo)(()=>l.filter(e=>"completed"===e.ocr_status).map(e=>e.id).sort().join(","),[l]);(0,s.useEffect)(()=>{let e=l.filter(e=>"completed"===e.ocr_status);p(t=>{let s=new Set(t.map(e=>e.id)),r=new Set(e.map(e=>e.id));return s.size===r.size&&[...s].every(e=>r.has(e))?t:e.map(e=>{let s=t.find(t=>t.id===e.id);return{id:e.id,fileName:e.file_name,exhibitNumber:e.exhibit_number||"N/A",status:s?.status||"pending",pageCount:e.page_count||1}})})},[X,l]),(0,s.useEffect)(()=>{!g&&h.length>0&&b(h[0])},[g,h]);let ee=(0,s.useMemo)(()=>g?h.find(e=>e.id===g.id)?.status??null:null,[h,g?.id]);(0,s.useEffect)(()=>{g&&ee&&ee!==g.status&&b(e=>e?{...e,status:ee}:null)},[ee,g?.status]),(0,s.useEffect)(()=>{W.current=!1},[e]),(0,s.useEffect)(()=>{(async()=>{if(!W.current&&0!==h.length){W.current=!0;try{let t=await u(e);p(e=>{let s=!1,r=e.map(e=>{let r=t.documents?.find(t=>t.id===e.id);if(r){let t=r.highlight_status||"pending";if(e.status!==t)return s=!0,{...e,status:t,pageCount:r.page_count||e.pageCount}}return e});return s?r:e})}catch(e){console.error("Failed to load highlight status:",e)}}})()},[e,h.length]);let et=w||h.some(e=>"processing"===e.status)?"processing":h.length>0&&h.every(e=>"completed"===e.status)?"completed":"idle",es=h.filter(e=>"pending"===e.status||"not_started"===e.status).length,er=h.filter(e=>"completed"===e.status).length,ea=async e=>{try{let t;p(t=>t.map(t=>t.id===e.id?{...t,status:"processing"}:t)),await (t=e.id,a(`/api/highlight/${t}`,{method:"POST"})),Z()}catch(t){console.error("Highlight failed:",t),o(t instanceof Error&&t.message.includes("fetch")?"无法连接后端服务":"高光分析启动失败"),p(t=>t.map(t=>t.id===e.id?{...t,status:"pending"}:t))}},el=async()=>{if(0!==es)try{let t;p(e=>e.map(e=>"pending"===e.status||"not_started"===e.status?{...e,status:"processing"}:e)),await (t=e,a(`/api/highlight/batch/${t}`,{method:"POST"})),i("高光分析已启动"),Z()}catch(e){console.error("Batch highlight failed:",e),o(e instanceof Error&&e.message.includes("fetch")?"无法连接后端服务":"批量高光分析启动失败"),p(e=>e.map(e=>"processing"===e.status?{...e,status:"pending"}:e))}},en=h.find(e=>e.id===g?.id)?.status;(0,s.useEffect)(()=>{(async()=>{if(!g||"completed"!==en)return L([]);if(!z.current){z.current=!0,$(!0);try{let e=await x(g.id);L(e.highlights||[])}catch(e){console.error("Failed to load highlights:",e),L([])}finally{$(!1),z.current=!1}}})(),M(1),B(null)},[g?.id,en]);let ei=e=>{b(e)};return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center text-yellow-600",children:(0,t.jsx)(F,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:"高光模块"}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[er,"/",h.length," 已完成"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("button",{onClick:el,disabled:0===es||w||!c,className:"flex items-center gap-1.5 px-3 py-1.5 bg-yellow-500 text-white text-xs font-medium rounded-lg hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:c?void 0:"模型加载中...",children:[(0,t.jsx)(T,{}),c?"全部分析":"模型加载中..."]}),(0,t.jsx)(({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:"等待分析"},processing:{bg:"bg-yellow-100",text:"text-yellow-700",label:"分析中"},completed:{bg:"bg-green-100",text:"text-green-700",label:"已完成"}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},{status:et})]})]})}),(0,t.jsxs)("div",{className:"flex",style:{height:"500px"},children:[(0,t.jsxs)("div",{className:`border-r border-gray-200 flex flex-col transition-all duration-300 ${f?"w-10":"w-56"}`,children:[(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[!f&&(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:"文件列表"}),(0,t.jsx)("button",{onClick:()=>j(!f),className:"p-1 hover:bg-gray-200 rounded transition-colors",title:f?"展开":"折叠",children:f?(0,t.jsx)(H,{}):(0,t.jsx)(D,{})})]}),f?(0,t.jsx)("div",{className:"flex-1 overflow-y-auto py-1",children:h.map(e=>(0,t.jsx)("div",{onClick:()=>ei(e),className:`flex items-center justify-center py-2 cursor-pointer transition-colors ${g?.id===e.id?"bg-yellow-50":"hover:bg-gray-50"}`,title:`${e.exhibitNumber}: ${e.fileName}`,children:(0,t.jsx)(q,{status:e.status})},e.id))}):(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===h.length?(0,t.jsxs)("div",{className:"p-4 text-center text-xs text-gray-400",children:["暂无可分析的文件",(0,t.jsx)("p",{className:"mt-1",children:"请先完成 OCR"})]}):(0,t.jsx)("div",{className:"py-1",children:h.map(e=>(0,t.jsxs)("div",{onClick:()=>ei(e),className:`flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors ${g?.id===e.id?"bg-yellow-50 border-r-2 border-yellow-500":"hover:bg-gray-50"}`,children:[(0,t.jsx)(q,{status:e.status}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 truncate",children:e.exhibitNumber}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:e.fileName,children:e.fileName})]}),("pending"===e.status||"not_started"===e.status)&&!w&&c&&(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),ea(e)},className:"px-1.5 py-0.5 text-xs text-yellow-600 hover:bg-yellow-100 rounded transition-colors",children:"分析"})]},e.id))})})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,t.jsx)("div",{className:"px-4 py-2 border-b border-gray-100 bg-gray-50",children:(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:g?`PDF 预览 - ${g.exhibitNumber}: ${g.fileName}`:"PDF 预览"})}),(0,t.jsx)("div",{className:"flex-1 overflow-hidden p-2",children:(0,t.jsx)(O,{documentId:g?.id||null,documentName:g?.fileName,pageCount:g?.pageCount||1,currentPage:_,onPageChange:M,selectedHighlightId:E})})]}),(0,t.jsxs)("div",{className:`border-l border-gray-200 flex flex-col transition-all duration-300 ${y?"w-10":"w-64"}`,children:[(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[(0,t.jsx)("button",{onClick:()=>v(!y),className:"p-1 hover:bg-gray-200 rounded transition-colors",title:y?"展开":"折叠",children:y?(0,t.jsx)(D,{}):(0,t.jsx)(H,{})}),!y&&(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-600",children:["高光列表 ",C.length>0&&`(${C.length})`]})]}),y?(0,t.jsx)("div",{className:"flex-1 flex flex-col items-center py-4",children:(0,t.jsx)("span",{className:"text-xs text-gray-500 [writing-mode:vertical-lr]",children:C.length>0?`${C.length} 高光`:"无高光"})}):(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:S?(0,t.jsx)("div",{className:"p-4 flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-5 h-5 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin"})}):0===C.length?(0,t.jsx)("div",{className:"p-4 text-center text-xs text-gray-400",children:g?.status==="completed"?"暂无高光":"完成分析后显示高光"}):(0,t.jsx)("div",{className:"py-1",children:C.map((e,s)=>(0,t.jsxs)("div",{onClick:()=>{M(e.page_number),B(e.id)},className:`px-3 py-2 cursor-pointer transition-colors border-b border-gray-50 ${E===e.id?"bg-yellow-50 border-l-2 border-l-yellow-500":"hover:bg-gray-50"}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,t.jsxs)("span",{className:"text-xs text-gray-400",children:["#",s+1]}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["P.",e.page_number]}),e.category_cn&&(0,t.jsx)("span",{className:"px-1.5 py-0.5 text-xs rounded bg-yellow-100 text-yellow-700",children:e.category_cn}),"high"===e.importance&&(0,t.jsx)("span",{className:"px-1.5 py-0.5 text-xs rounded bg-red-100 text-red-600",children:"重要"})]}),(0,t.jsx)("p",{className:"text-xs text-gray-700 line-clamp-2",children:e.text_content||"无文本内容"})]},e.id||s))})})]})]})]})}let V={qualifying_relationship:{chinese:"合格的公司关系",english:"Qualifying Corporate Relationship",description:"美国公司与海外公司必须是母/子/分/关联公司关系",keywords:["母公司","子公司","关联公司","分公司","所有权","股权","持股","控股","共同控制"]},qualifying_employment:{chinese:"海外合格任职",english:"Qualifying Employment Abroad",description:"受益人过去3年中在海外关联公司连续工作至少1年",keywords:["任职","工作","职位","入职","离职","任期","年限","海外","境外"]},qualifying_capacity:{chinese:"合格的职位性质",english:"Qualifying Capacity",description:"L-1A: 高管/经理; L-1B: 专业知识人员",keywords:["高管","经理","管理","决策","战略","专业知识","专有技术","指导","监督","人事权","预算"]},doing_business:{chinese:"持续运营",english:"Doing Business",description:"美国和海外公司都必须持续、积极运营",keywords:["收入","利润","员工","雇员","银行","存款","合同","业务","办公","注册"]}},I=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),J=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),U=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),K=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})}),G=({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:"等待分析"},processing:{bg:"bg-indigo-100",text:"text-indigo-700",label:"分析中"},completed:{bg:"bg-green-100",text:"text-green-700",label:"已完成"},error:{bg:"bg-red-100",text:"text-red-700",label:"分析失败"}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},Q=({quote:e,index:r})=>{let[a,l]=(0,s.useState)(!1);return(0,t.jsx)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-indigo-200 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsxs)("span",{className:"text-xs text-gray-400 mt-0.5",children:["#",r+1]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("p",{className:`text-sm text-gray-700 ${a?"":"line-clamp-2"}`,children:['"',e.quote,'"']}),e.quote.length>100&&(0,t.jsx)("button",{onClick:()=>l(!a),className:"text-xs text-indigo-600 hover:text-indigo-800 mt-1",children:a?"收起":"展开"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-2 flex-wrap",children:[(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600",children:e.source?.exhibit_id||"N/A"}),e.page&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["P.",e.page]})]}),e.relevance&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1 italic",children:["相关性: ",e.relevance]})]})]})})},Y=({standardKey:e,quotes:r,defaultExpanded:a=!1})=>{let[l,n]=(0,s.useState)(a),i=V[e];return i?(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[(0,t.jsxs)("button",{onClick:()=>n(!l),className:"w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex items-center justify-between transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-indigo-100 text-indigo-700",children:r.length}),(0,t.jsxs)("div",{className:"text-left",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900",children:i.chinese}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:i.english})]})]}),l?(0,t.jsx)(K,{}):(0,t.jsx)(U,{})]}),l&&(0,t.jsx)("div",{className:"p-4 space-y-3 bg-white",children:0===r.length?(0,t.jsx)("p",{className:"text-sm text-gray-400 text-center py-4",children:"暂无相关引用"}):r.map((e,s)=>(0,t.jsx)(Q,{quote:e,index:s},s))})]}):null};function Z({projectId:e,onSuccess:l,onError:n}){let i,[o,c]=(0,s.useState)("idle"),[x,u]=(0,s.useState)(null),[m,h]=(0,s.useState)(!1),[p,g]=(0,s.useState)(null),{isConnected:b,connect:f,disconnect:j}=N({url:e?(i=e,`${r}/api/l1-analyze/stream/${i}`):null,onMessage:(0,s.useCallback)(e=>{g(e),"processing"===e.status&&c("processing")},[]),onComplete:(0,s.useCallback)(async t=>{if(g(t),"completed"===t.status&&e)try{let s;await (s=e,a(`/api/l1-summary/${s}`,{method:"POST"}));let r=await d(e);u(r),c("completed"),l?.(`L-1 分析完成: 分析了 ${t.completed} 个文档，找到 ${t.total_quotes_found} 条引用`)}catch(e){console.error("Failed to generate summary:",e),c("completed")}},[e,l]),onError:(0,s.useCallback)(()=>{console.warn("L1 SSE connection error")},[]),autoConnect:!1});(0,s.useEffect)(()=>(e?y():(u(null),c("idle"),g(null)),()=>{j()}),[e,j]);let y=async()=>{if(e)try{let t;h(!0);let s=await (t=e,a(`/api/l1-status/${t}`));if(s.has_summary&&s.summary_quotes>0){let t=await d(e);u(t),c("completed")}else u(null),c("idle")}catch(e){console.error("Failed to load existing analysis:",e),u(null),c("idle")}finally{h(!1)}},v=async()=>{if(e)try{var t;let s;if(c("processing"),g(null),(await (t=e,s="",a(`/api/l1-analyze/${t}${s}`,{method:"POST"}))).success)f();else throw Error("Failed to start analysis")}catch(t){console.error("L-1 analysis failed:",t);let e=t instanceof Error&&t.message.includes("fetch")?"无法连接后端服务":"L-1 分析启动失败";n?.(e),c("error")}},w=x?.total_quotes||0,k=e=>x?.by_standard&&x.by_standard[e]||[];return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600",children:(0,t.jsx)(I,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:"L-1 关键原文引用分析"}),w>0&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[w," 条引用"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:v,disabled:!e||"processing"===o,className:"flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"processing"===o?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),"分析中..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(J,{}),"completed"===o?"重新分析":"开始分析"]})}),(0,t.jsx)(G,{status:o})]})]})}),(0,t.jsx)("div",{className:"p-4",children:e?m?(0,t.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-500",children:"加载中..."})]}):"processing"===o?(0,t.jsxs)("div",{className:"py-6",children:[(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm mb-2",children:[(0,t.jsxs)("span",{className:"text-gray-600",children:["分析进度: ",p?.completed||0,"/",p?.total||0," 个文档"]}),(0,t.jsxs)("span",{className:"text-indigo-600 font-medium",children:[p?.progress_percent||0,"%"]})]}),(0,t.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,t.jsx)("div",{className:"bg-indigo-600 h-2 rounded-full transition-all duration-300",style:{width:`${p?.progress_percent||0}%`}})})]}),p?.current_doc&&(0,t.jsx)("div",{className:"bg-indigo-50 rounded-lg p-3 mb-3",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"}),(0,t.jsxs)("span",{className:"text-sm text-indigo-700",children:["正在分析: ",p.current_doc.exhibit_id," - ",p.current_doc.file_name]})]})}),p&&p.total_quotes_found>0&&(0,t.jsxs)("div",{className:"text-center text-sm text-gray-500",children:["已找到 ",p.total_quotes_found," 条引用"]}),p?.errors&&p.errors.length>0&&(0,t.jsxs)("div",{className:"mt-3 text-sm text-red-600",children:[p.errors.length," 个文档分析失败"]})]}):"idle"===o?(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:'点击"开始分析"提取 L-1 关键原文引用'}),(0,t.jsx)("p",{className:"mt-1 text-xs",children:"将从 OCR 结果中自动识别符合 L-1 标准的关键引用"})]}):"error"===o?(0,t.jsxs)("div",{className:"text-center py-8 text-red-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:"分析失败，请重试"})]}):x&&w>0?(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("div",{className:"grid grid-cols-4 gap-3 mb-4",children:Object.keys(V).map(e=>{let s=k(e).length,r=V[e];return(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-indigo-600",children:s}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:r.chinese,children:r.chinese})]},e)})}),(0,t.jsx)("div",{className:"space-y-3",children:Object.keys(V).map((e,s)=>(0,t.jsx)(Y,{standardKey:e,quotes:k(e),defaultExpanded:0===s},e))})]}):(0,t.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,t.jsx)("p",{className:"text-sm",children:"分析完成，但未找到符合条件的引用"})}):(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)(I,{}),(0,t.jsx)("p",{className:"mt-2 text-sm",children:"请先选择一个项目"})]})})]})}let X=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),ee=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),et=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),es=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})}),er={person:"人物",organization:"组织",company:"公司",date:"日期",location:"地点",position:"职位",event:"事件",document:"文档"},ea={works_for:"任职于",owns:"拥有",subsidiary_of:"子公司",affiliated_with:"关联",employed_by:"受雇于",manages:"管理",reports_to:"汇报给",founded:"创立",located_in:"位于"},el=({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:"等待分析"},processing:{bg:"bg-rose-100",text:"text-rose-700",label:"分析中"},completed:{bg:"bg-green-100",text:"text-green-700",label:"已完成"},error:{bg:"bg-red-100",text:"text-red-700",label:"分析失败"}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},en=({entity:e})=>{let s=er[e.type]||e.type,r={person:"bg-blue-100 text-blue-700",organization:"bg-purple-100 text-purple-700",company:"bg-green-100 text-green-700",date:"bg-yellow-100 text-yellow-700",location:"bg-orange-100 text-orange-700",position:"bg-pink-100 text-pink-700",event:"bg-cyan-100 text-cyan-700",document:"bg-gray-100 text-gray-700"}[e.type]||"bg-gray-100 text-gray-700";return(0,t.jsx)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-rose-200 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${r}`,children:s}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.name}),e.documents.length>0&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["来源: ",e.documents.slice(0,3).join(", "),e.documents.length>3&&` +${e.documents.length-3}`]})]})]})})},ei=({relation:e,entities:s})=>{let r=s.find(t=>t.id===e.source_id),a=s.find(t=>t.id===e.target_id),l=ea[e.relation_type]||e.relation_type;return(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-rose-200 transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-rose-50 text-rose-700 border border-rose-200",children:r?.name||e.source_id}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:(0,t.jsx)("svg",{className:"w-4 h-4 inline",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})}),(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-700",children:l}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:(0,t.jsx)("svg",{className:"w-4 h-4 inline",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})}),(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-rose-50 text-rose-700 border border-rose-200",children:a?.name||e.target_id})]}),e.description&&(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:e.description})]})},eo=({chain:e})=>{let[r,a]=(0,s.useState)(!1);return(0,t.jsx)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-rose-200 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded flex-shrink-0 ${{strong:"bg-green-100 text-green-700",medium:"bg-yellow-100 text-yellow-700",weak:"bg-red-100 text-red-700"}[e.strength]||"bg-gray-100 text-gray-700"}`,children:{strong:"强",medium:"中",weak:"弱"}[e.strength]||e.strength}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:`text-sm text-gray-700 ${r?"":"line-clamp-2"}`,children:e.claim}),e.claim.length>100&&(0,t.jsx)("button",{onClick:()=>a(!r),className:"text-xs text-rose-600 hover:text-rose-800 mt-1",children:r?"收起":"展开"}),e.documents.length>0&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:["证据来源: ",e.documents.join(", ")]}),e.reasoning&&r&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1 italic",children:["推理: ",e.reasoning]})]})]})})},ec=({title:e,count:r,children:a,defaultExpanded:l=!1})=>{let[n,i]=(0,s.useState)(l);return(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[(0,t.jsxs)("button",{onClick:()=>i(!n),className:"w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex items-center justify-between transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-rose-100 text-rose-700",children:r}),(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e})]}),n?(0,t.jsx)(es,{}):(0,t.jsx)(et,{})]}),n&&(0,t.jsx)("div",{className:"p-4 space-y-3 bg-white",children:a})]})};function ed({projectId:e,onSuccess:l,onError:n}){let i,[o,c]=(0,s.useState)("idle"),[d,x]=(0,s.useState)(null),[u,m]=(0,s.useState)(!1),{connect:h,disconnect:p}=N({url:e?(i=e,`${r}/api/relationship/stream/${i}`):null,onMessage:(0,s.useCallback)(e=>{"processing"===e.status&&c("processing")},[]),onComplete:(0,s.useCallback)(e=>{"completed"===e.status&&e.result?(x(e.result),c("completed"),l?.(`关系分析完成: 识别了 ${e.result.entities?.length||0} 个实体，${e.result.relations?.length||0} 条关系`)):"failed"===e.status&&(c("error"),n?.(e.error||"关系分析失败"))},[l,n]),onError:(0,s.useCallback)(()=>{console.warn("Relationship SSE connection error")},[]),autoConnect:!1});(0,s.useEffect)(()=>(e?g():(x(null),c("idle")),()=>{p()}),[e,p]);let g=async()=>{if(e)try{let t;m(!0);let s=await (t=e,a(`/api/projects/${t}/relationship`));s.data&&(s.data.entities.length>0||s.data.relations.length>0)?(x(s.data),c("completed")):(x(null),c("idle"))}catch(e){console.error("Failed to load existing relationship analysis:",e),x(null),c("idle")}finally{m(!1)}},b=async()=>{if(e)try{var t;let s;if(c("processing"),(await (t=e,s="",a(`/api/relationship/${t}${s}`,{method:"POST"}))).success)h();else throw Error("Failed to start analysis")}catch(t){console.error("Relationship analysis failed:",t);let e=t instanceof Error&&t.message.includes("fetch")?"无法连接后端服务":"关系分析启动失败";n?.(e),c("error")}},f=d?.entities.length||0,j=d?.relations.length||0,y=d?.evidence_chains.length||0,v=d?.entities.reduce((e,t)=>{let s=t.type||"other";return e[s]||(e[s]=[]),e[s].push(t),e},{})||{};return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-rose-100 rounded-lg flex items-center justify-center text-rose-600",children:(0,t.jsx)(X,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:"关系分析"}),(f>0||j>0)&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[f," 实体 | ",j," 关系"]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:b,disabled:!e||"processing"===o,className:"flex items-center gap-1.5 px-3 py-1.5 bg-rose-600 text-white text-xs font-medium rounded-lg hover:bg-rose-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"processing"===o?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),"分析中..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(ee,{}),"completed"===o?"重新分析":"开始分析"]})}),(0,t.jsx)(el,{status:o})]})]})}),(0,t.jsx)("div",{className:"p-4",children:e?u?(0,t.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-rose-500 border-t-transparent rounded-full animate-spin"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-500",children:"加载中..."})]}):"idle"===o?(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:'点击"开始分析"提取实体关系'}),(0,t.jsx)("p",{className:"mt-1 text-xs",children:"将分析文档中的人物、组织、时间等实体及其关系"})]}):"error"===o?(0,t.jsxs)("div",{className:"text-center py-8 text-red-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:"分析失败，请重试"})]}):d&&(f>0||j>0)?(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-rose-600",children:f}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"实体"})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-rose-600",children:j}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"关系"})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-rose-600",children:y}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"证据链"})]})]}),f>0&&(0,t.jsx)(ec,{title:"实体列表",count:f,defaultExpanded:!0,children:Object.entries(v).map(([e,s])=>(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("p",{className:"text-xs font-medium text-gray-500 uppercase",children:[er[e]||e," (",s.length,")"]}),(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:s.map(e=>(0,t.jsx)(en,{entity:e},e.id))})]},e))}),j>0&&(0,t.jsx)(ec,{title:"关系列表",count:j,children:(0,t.jsx)("div",{className:"space-y-2",children:d.relations.map((e,s)=>(0,t.jsx)(ei,{relation:e,entities:d.entities},s))})}),y>0&&(0,t.jsx)(ec,{title:"证据链",count:y,children:(0,t.jsx)("div",{className:"space-y-2",children:d.evidence_chains.map((e,s)=>(0,t.jsx)(eo,{chain:e},s))})})]}):(0,t.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,t.jsx)("p",{className:"text-sm",children:"分析完成，但未识别到实体或关系"})}):(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)(X,{}),(0,t.jsx)("p",{className:"mt-2 text-sm",children:"请先选择一个项目"})]})})]})}let ex=["qualifying_relationship","qualifying_employment","qualifying_capacity","doing_business"],eu={qualifying_relationship:"Qual. Relationship",qualifying_employment:"Qual. Employment",qualifying_capacity:"Qual. Capacity",doing_business:"Doing Business"},em=({status:e})=>(0,t.jsx)("span",{className:`w-2 h-2 rounded-full ${{empty:"bg-gray-300",draft:"bg-yellow-400",complete:"bg-green-500"}[e]}`});function eh({activeSection:e,onSectionChange:s,sectionStatus:r={qualifying_relationship:"empty",qualifying_employment:"empty",qualifying_capacity:"empty",doing_business:"empty"}}){return(0,t.jsx)("div",{className:"flex border-b border-gray-200 bg-white",children:ex.map(a=>{let l=e===a,n=r[a],i=V[a];return(0,t.jsxs)("button",{onClick:()=>s(a),className:`
              flex items-center gap-2 px-4 py-3 text-sm font-medium transition-colors
              border-b-2 -mb-[2px]
              ${l?"border-blue-600 text-blue-600 bg-blue-50":"border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-50"}
            `,title:i.english,children:[(0,t.jsx)(em,{status:n}),(0,t.jsx)("span",{className:"hidden sm:inline",children:eu[a]}),(0,t.jsx)("span",{className:"sm:hidden",children:a.split("_")[1].slice(0,3)})]},a)})})}function ep({citation:e,position:r,onClose:l}){let[n,i]=(0,s.useState)(null),[o,c]=(0,s.useState)(!0),[d,x]=(0,s.useState)(null);(0,s.useEffect)(()=>{let t=!0;return(async()=>{try{var s,r,l;let n;c(!0),x(null);let o=await (s=e.document_id,r=e.page_number,n=(l=e.bbox)?`?bbox=${encodeURIComponent(JSON.stringify(l))}`:"",a(`/api/pdf-preview/${s}/${r}${n}`));t&&i(o.image)}catch(e){t&&(x("Failed to load preview"),console.error("Preview load error:",e))}finally{t&&c(!1)}})(),()=>{t=!1}},[e.document_id,e.page_number,e.bbox]),(0,s.useEffect)(()=>{let e=e=>{e.target.closest(".citation-tooltip")||l()};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[l]);let u={x:Math.min(r.x,window.innerWidth-280),y:r.y+20};return(0,t.jsxs)("div",{className:"citation-tooltip fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-3 w-64 animate-fade-in",style:{left:u.x,top:u.y},children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-700",children:["Exhibit ",e.exhibit]}),(0,t.jsx)("button",{onClick:l,className:"text-gray-400 hover:text-gray-600",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500 mb-2",children:[e.file_name," - Page ",e.page_number]}),(0,t.jsx)("div",{className:"relative bg-gray-100 rounded border border-gray-200 overflow-hidden",children:o?(0,t.jsx)("div",{className:"h-32 flex items-center justify-center",children:(0,t.jsxs)("svg",{className:"w-6 h-6 text-gray-400 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):d?(0,t.jsx)("div",{className:"h-32 flex items-center justify-center text-gray-400 text-xs",children:d}):n?(0,t.jsx)("img",{src:n,alt:`Page ${e.page_number} preview`,className:"w-full h-auto"}):null}),e.quote&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-600 line-clamp-3 italic border-l-2 border-blue-300 pl-2",children:["“",e.quote,"”"]}),e.claim&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-500",children:[(0,t.jsx)("span",{className:"font-medium",children:"Supports:"})," ",e.claim]})]})}function eg({selection:e,position:s,onEdit:r,onCopy:a,onClose:l}){let n={x:Math.max(10,Math.min(s.x-50,window.innerWidth-130)),y:s.y-45};return(0,t.jsxs)("div",{className:"fixed z-50 animate-fade-in",style:{left:n.x,top:n.y},children:[(0,t.jsxs)("div",{className:"bg-gray-900 text-white px-2 py-1.5 rounded-lg shadow-lg flex items-center gap-1",children:[(0,t.jsxs)("button",{onClick:r,className:"flex items-center gap-1.5 px-2 py-1 rounded hover:bg-gray-700 transition-colors text-sm",title:"Edit selection",children:[(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,t.jsx)("span",{children:"Edit"})]}),a&&(0,t.jsx)("div",{className:"w-px h-4 bg-gray-600"}),a&&(0,t.jsx)("button",{onClick:a,className:"flex items-center gap-1.5 px-2 py-1 rounded hover:bg-gray-700 transition-colors text-sm",title:"Copy selection",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})})}),(0,t.jsx)("button",{onClick:l,className:"flex items-center px-1.5 py-1 rounded hover:bg-gray-700 transition-colors",title:"Close",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsx)("div",{className:"absolute left-1/2 transform -translate-x-1/2 -bottom-1.5",children:(0,t.jsx)("div",{className:"w-3 h-3 bg-gray-900 rotate-45"})})]})}let eb=/\[Exhibit\s+([A-Z]-?\d+)(?::\s*([^\]]+))?\]/g;function ef({content:e,onChange:r,citations:a,onSelectionChange:l,selectionEditMode:n,onEditSelection:i,readOnly:o=!1}){let c=(0,s.useRef)(null),[d,x]=(0,s.useState)(null),[u,m]=(0,s.useState)(null),h=(0,s.useCallback)(e=>a.find(t=>t.exhibit===e),[a]),p=(0,s.useCallback)((e,t)=>{let s=h(e);if(s){let e=t.target.getBoundingClientRect();x({citation:s,position:{x:e.left,y:e.bottom}})}},[h]),g=(0,s.useCallback)(()=>{setTimeout(()=>{x(null)},100)},[]),b=(0,s.useCallback)(()=>{let t=window.getSelection();if(!t||t.isCollapsed||!c.current){m(null),l(null);return}let s=t.toString().trim();if(!s){m(null),l(null);return}let r=t.getRangeAt(0).getBoundingClientRect(),a=e.indexOf(s),n=a+s.length,i={text:s,start:a>=0?a:0,end:a>=0?n:s.length,position:{x:r.left+r.width/2,y:r.top}};m(i),l({text:i.text,start:i.start,end:i.end})},[e,l]);(0,s.useEffect)(()=>(document.addEventListener("selectionchange",b),()=>document.removeEventListener("selectionchange",b)),[b]);let f=(0,s.useCallback)(e=>{let t=e.target;if(t.closest(".citation-link")||t.closest(".selection-bubble"))return},[]),j=(0,s.useCallback)(e=>{r(e.target.innerText)},[r]);return(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{ref:c,contentEditable:!o,suppressContentEditableWarning:!0,onInput:j,onClick:f,className:`min-h-[300px] p-4 text-gray-800 leading-relaxed focus:outline-none ${o?"bg-gray-50":"bg-white"}`,style:{whiteSpace:"pre-wrap"},children:(function(e){let t=[],s=0;for(let r of e.matchAll(eb))r.index>s&&t.push({type:"text",content:e.slice(s,r.index)}),t.push({type:"citation",content:r[0],exhibit:r[1],title:r[2]}),s=r.index+r[0].length;return s<e.length&&t.push({type:"text",content:e.slice(s)}),t})(e).map((e,s)=>{if("citation"===e.type){let r=h(e.exhibit);return(0,t.jsxs)("span",{className:`citation-link inline-flex items-center px-1 py-0.5 rounded text-sm font-medium cursor-pointer transition-colors ${r?"bg-blue-100 text-blue-700 hover:bg-blue-200":"bg-gray-100 text-gray-600"}`,onMouseEnter:t=>p(e.exhibit,t),onMouseLeave:g,children:[(0,t.jsx)("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.content]},s)}return(0,t.jsx)("span",{children:e.content},s)})}),d&&(0,t.jsx)(ep,{citation:d.citation,position:d.position,onClose:()=>x(null)}),u&&"bubble"===n&&(0,t.jsx)(eg,{selection:{text:u.text,start:u.start,end:u.end},position:u.position,onEdit:i,onCopy:()=>navigator.clipboard.writeText(u.text),onClose:()=>{m(null),l(null),window.getSelection()?.removeAllRanges()}}),u&&"panel"===n&&(0,t.jsxs)("div",{className:"absolute top-2 right-2 bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full",children:[u.text.length," chars selected"]})]})}let ej=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),ey=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})});function ev({mode:e,selection:r,onSend:a,onShowHistory:l,isProcessing:n,recentMessages:i=[]}){let[o,c]=(0,s.useState)(""),d=(0,s.useRef)(null);(0,s.useEffect)(()=>{"right"===e&&r&&d.current&&d.current.focus()},[r,e]);let x=async e=>{e?.preventDefault(),o.trim()&&!n&&(await a(o.trim(),r),c(""))},u=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),x())};return"bottom"===e?(0,t.jsxs)("div",{className:"border-t border-gray-200 bg-white p-4",children:[r&&(0,t.jsxs)("div",{className:"mb-3 flex items-start gap-2 p-2 bg-yellow-50 rounded-lg border border-yellow-200",children:[(0,t.jsx)("span",{className:"text-xs text-yellow-700 font-medium whitespace-nowrap",children:"Selected:"}),(0,t.jsxs)("span",{className:"text-xs text-yellow-800 line-clamp-2",children:["“",r.text,"”"]})]}),(0,t.jsxs)("form",{onSubmit:x,className:"flex items-end gap-3",children:[(0,t.jsx)("div",{className:"flex-1 relative",children:(0,t.jsx)("textarea",{ref:d,value:o,onChange:e=>c(e.target.value),onKeyDown:u,placeholder:r?"How should I modify this selection?":"Enter editing instructions...",className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",rows:1,disabled:n})}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{type:"button",onClick:l,className:"p-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-xl transition-colors",title:"View history",children:(0,t.jsx)(ey,{})}),(0,t.jsx)("button",{type:"submit",disabled:!o.trim()||n,className:"p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:n?(0,t.jsxs)("svg",{className:"w-5 h-5 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,t.jsx)(ej,{})})]})]})]}):(0,t.jsxs)("div",{className:"w-80 border-l border-gray-200 bg-white flex flex-col h-full",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-medium text-gray-900",children:"Edit Assistant"}),(0,t.jsx)("button",{onClick:l,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors",title:"View history",children:(0,t.jsx)(ey,{})})]}),r&&(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 bg-yellow-50",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"Selected text:"}),(0,t.jsxs)("div",{className:"text-sm text-gray-800 line-clamp-4 bg-white p-2 rounded border border-yellow-200",children:["“",r.text,"”"]})]}),i.length>0&&(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:i.slice(-3).map(e=>(0,t.jsx)("div",{className:`text-sm p-2 rounded-lg ${"user"===e.role?"bg-blue-50 text-blue-900 ml-4":"bg-gray-50 text-gray-700 mr-4"}`,children:e.content},e.id))}),(0,t.jsxs)("div",{className:"p-4 border-t border-gray-200 mt-auto",children:[(0,t.jsx)("textarea",{ref:d,value:o,onChange:e=>c(e.target.value),onKeyDown:u,placeholder:r?"How should I modify this?":"Enter editing instructions...",className:"w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",rows:3,disabled:n}),(0,t.jsx)("button",{onClick:()=>x(),disabled:!o.trim()||n,className:"mt-3 w-full py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2",children:n?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,t.jsx)("span",{children:"Processing..."})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{children:"Apply Changes"}),(0,t.jsx)(ej,{})]})})]})]})}function eN({isOpen:e,onClose:r,history:a,onApplyMessage:l}){let[n,i]=(0,s.useState)(""),o=(0,s.useRef)(null);(0,s.useEffect)(()=>{let t=e=>{"Escape"===e.key&&r()};if(e)return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[e,r]);let c=a.filter(e=>e.content.toLowerCase().includes(n.toLowerCase())).reduce((e,t)=>{let s,r,a,l=(s=new Date(t.timestamp),((a=new Date(r=new Date)).setDate(a.getDate()-1),s.toDateString()===r.toDateString())?"Today":s.toDateString()===a.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"}));return e[l]||(e[l]=[]),e[l].push(t),e},{});return e?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 bg-black/30 z-40 transition-opacity",onClick:r}),(0,t.jsxs)("div",{ref:o,className:"fixed right-0 top-0 h-full w-96 max-w-full bg-white shadow-xl z-50 flex flex-col animate-slide-in-right",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,t.jsx)("h2",{className:"font-semibold text-gray-900",children:"Edit History"}),(0,t.jsx)("button",{onClick:r,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("svg",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,t.jsx)("input",{type:"text",value:n,onChange:e=>i(e.target.value),placeholder:"Search history...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===Object.keys(c).length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,t.jsx)("p",{className:"text-sm",children:n?"No matching messages":"No history yet"})]}):(0,t.jsx)("div",{className:"divide-y divide-gray-100",children:Object.entries(c).map(([e,s])=>(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"px-4 py-2 bg-gray-50 sticky top-0",children:(0,t.jsx)("span",{className:"text-xs font-medium text-gray-500",children:e})}),(0,t.jsx)("div",{className:"divide-y divide-gray-50",children:s.map(e=>(0,t.jsxs)("div",{className:"p-4 hover:bg-gray-50 transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-2 mb-1",children:[(0,t.jsx)("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${"user"===e.role?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:"user"===e.role?"You":"Assistant"}),(0,t.jsx)("span",{className:"text-xs text-gray-400",children:new Date(e.timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})})]}),(0,t.jsx)("p",{className:"text-sm text-gray-700 line-clamp-3",children:e.content}),e.selection&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-500 bg-gray-100 p-2 rounded",children:[(0,t.jsx)("span",{className:"font-medium",children:"Selection:"})," ","“",e.selection.text.slice(0,50),e.selection.text.length>50?"...":"","”"]}),l&&"assistant"===e.role&&(0,t.jsx)("button",{onClick:()=>l(e),className:"mt-2 text-xs text-blue-600 hover:text-blue-800",children:"Apply this change"})]},e.id))})]},e))})}),(0,t.jsx)("div",{className:"p-4 border-t border-gray-200 bg-gray-50",children:(0,t.jsxs)("p",{className:"text-xs text-gray-500 text-center",children:[a.length," message",1!==a.length?"s":""," in history"]})})]})]}):null}let ew=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),ek=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),eC=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),eL=()=>(0,t.jsxs)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]});function eS({projectId:e,onSuccess:r,onError:l,modelsReady:n=!0}){let[i,o]=(0,s.useState)("qualifying_relationship"),[c,d]=(0,s.useState)({qualifying_relationship:{content:"",citations:[],status:"empty"},qualifying_employment:{content:"",citations:[],status:"empty"},qualifying_capacity:{content:"",citations:[],status:"empty"},doing_business:{content:"",citations:[],status:"empty"}}),[x,u]=(0,s.useState)([]),[m,h]=(0,s.useState)(!1),[p,g]=(0,s.useState)(null),[b,f]=(0,s.useState)("bottom"),[j,y]=(0,s.useState)("bubble"),[v,N]=(0,s.useState)(!1),[w,k]=(0,s.useState)(!1),[C,L]=(0,s.useState)(!1),[S,$]=(0,s.useState)(!1),[_,M]=(0,s.useState)({});(0,s.useEffect)(()=>{E(),B()},[e]);let E=async()=>{try{let t,s=await (t=e,a(`/api/l1-writing/${t}`));if(s.sections){let e={...c};Object.entries(s.sections).forEach(([t,s])=>{t in e&&(e[t]={content:s.text,citations:s.citations.map(e=>({...e,document_id:"",page_number:1})),status:s.text?"draft":"empty"})}),d(e)}}catch(e){console.error("Failed to load existing writing:",e)}},B=async()=>{try{let t,s=await (t=e,a(`/api/citation-index/${t}`)),r={};Object.entries(s.citations).forEach(([e,t])=>{if(t.quotes&&t.quotes.length>0){let s=t.quotes[0];r[e]={exhibit:e,file_name:t.file_name,quote:s.text,claim:"",document_id:t.document_id,page_number:s.page,bbox:s.bbox}}}),M(r)}catch(e){console.error("Failed to load citation index:",e)}},W=(0,s.useCallback)(e=>{d(t=>({...t,[i]:{...t[i],content:e,status:e?"draft":"empty"}}))},[i]),z=(0,s.useCallback)(e=>{g(e)},[]),R=(0,s.useCallback)(()=>{"bubble"===j&&f("right")},[j]),O=async(t,s)=>{if(!t.trim())return;k(!0);let n={id:`msg-${Date.now()}`,role:"user",content:t,selection:s||void 0,timestamp:new Date().toISOString()};u(e=>[...e,n]);try{let l,n,o,d,x,m=c[i].content,h=await (l=e,n=i,o=m,d=t,x=s||void 0,a(`/api/l1-revise/${l}`,{method:"POST",body:JSON.stringify({section_type:n,current_content:o,instruction:d,selection:x||null})}));W(h.revised_content);let p={id:`msg-${Date.now()}-response`,role:"assistant",content:h.changes_made||"Changes applied successfully.",timestamp:new Date().toISOString()};u(e=>[...e,p]),g(null),window.getSelection()?.removeAllRanges(),r?.("Content updated")}catch(t){console.error("Failed to apply changes:",t),l?.("Failed to apply changes");let e={id:`msg-${Date.now()}-error`,role:"assistant",content:"Sorry, I encountered an error. Please try again.",timestamp:new Date().toISOString()};u(t=>[...t,e])}finally{k(!1)}},P=async()=>{L(!0);try{let t,s,l=await (t=e,s=i,a(`/api/l1-write/${t}?section_type=${s}`,{method:"POST"}));if(l.paragraph){W(l.paragraph.text);let e=l.paragraph.citations.map(e=>{let t=_[e.exhibit];return{...e,document_id:t?.document_id||"",page_number:t?.page_number||1,bbox:t?.bbox}});d(t=>({...t,[i]:{...t[i],citations:e}})),r?.("Paragraph generated")}}catch(e){console.error("Failed to generate paragraph:",e),l?.("Failed to generate paragraph")}finally{L(!1)}},F=async()=>{$(!0);try{let t,s,l,n,o=c[i];await (t=e,s=i,l=o.content,n=o.citations,a(`/api/l1-write-manual/${t}`,{method:"POST",body:JSON.stringify({section_type:s,paragraph_text:l,citations_used:n})})),d(e=>({...e,[i]:{...e[i],status:"complete"}})),r?.("Content saved")}catch(e){console.error("Failed to save:",e),l?.("Failed to save")}finally{$(!1)}},T=c[i],D=Object.fromEntries(Object.entries(c).map(([e,t])=>[e,t.status]));return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600",children:(0,t.jsx)(ew,{})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900",children:"Writing Editor"}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:"Draft and refine petition letter paragraphs"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>N(!v),className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",title:"Layout settings",children:(0,t.jsx)(eL,{})}),(0,t.jsxs)("button",{onClick:P,disabled:C||!n,className:"flex items-center gap-2 px-3 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors",children:[C?(0,t.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):(0,t.jsx)(eC,{}),"Generate"]}),(0,t.jsxs)("button",{onClick:F,disabled:S||!T.content,className:"flex items-center gap-2 px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors",children:[S?(0,t.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):(0,t.jsx)(ek,{}),"Save"]})]})]}),v&&(0,t.jsxs)("div",{className:"px-6 py-3 border-b border-gray-200 bg-gray-50 flex items-center gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-sm text-gray-600",children:"Dialog position:"}),(0,t.jsxs)("select",{value:b,onChange:e=>f(e.target.value),className:"text-sm border border-gray-300 rounded px-2 py-1",children:[(0,t.jsx)("option",{value:"bottom",children:"Bottom (ChatGPT style)"}),(0,t.jsx)("option",{value:"right",children:"Right panel"})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("span",{className:"text-sm text-gray-600",children:"Selection edit:"}),(0,t.jsxs)("select",{value:j,onChange:e=>y(e.target.value),className:"text-sm border border-gray-300 rounded px-2 py-1",children:[(0,t.jsx)("option",{value:"bubble",children:"Floating bubble"}),(0,t.jsx)("option",{value:"panel",children:"Side panel"})]})]})]}),(0,t.jsx)(eh,{activeSection:i,onSectionChange:o,sectionStatus:D}),(0,t.jsxs)("div",{className:`flex ${"right"===b?"flex-row":"flex-col"}`,children:[(0,t.jsx)("div",{className:"flex-1 min-h-[400px] border-b border-gray-200",children:(0,t.jsx)(ef,{content:T.content,onChange:W,citations:T.citations,onSelectionChange:z,selectionEditMode:j,onEditSelection:R})}),(0,t.jsx)(ev,{mode:b,selection:p,onSend:O,onShowHistory:()=>h(!0),isProcessing:w,recentMessages:x.slice(-3)})]}),(0,t.jsx)(eN,{isOpen:m,onClose:()=>h(!1),history:x}),!n&&(0,t.jsx)("div",{className:"px-6 py-3 bg-amber-50 border-t border-amber-200 text-sm text-amber-700",children:"LLM models are loading. Generation features will be available soon."})]})}let e$=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})}),e_=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),eM=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),eE=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),eB=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),eW=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})});function ez({message:e,type:r,onClose:a}){return(0,s.useEffect)(()=>{let e=setTimeout(a,3e3);return()=>clearTimeout(e)},[a]),(0,t.jsxs)("div",{className:`fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg ${"success"===r?"bg-green-500":"error"===r?"bg-red-500":"bg-blue-500"} text-white flex items-center gap-3 animate-slide-in z-50`,children:[(0,t.jsx)("span",{children:e}),(0,t.jsx)("button",{onClick:a,className:"text-white/80 hover:text-white",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}function eR(){let[e,r]=(0,s.useState)(!1),[l,n]=(0,s.useState)([]),[i,o]=(0,s.useState)(null),[c,d]=(0,s.useState)(!0),[x,u]=(0,s.useState)(!1),[h,p]=(0,s.useState)(!1),[g,b]=(0,s.useState)(""),[f,j]=(0,s.useState)([]),[y,N]=(0,s.useState)(!1),[w,k]=(0,s.useState)("checking"),[C,L]=(0,s.useState)(null),S=(0,s.useCallback)(async()=>{try{let e=await fetch("https://petigen.zacchen.win/");k(e.ok?"online":"offline")}catch{k("offline")}},[]),{data:$}=m({fetcher:()=>a("/api/preload-status"),shouldContinue:e=>e.is_loading&&!e.is_ready,interval:2e3,errorRetryInterval:5e3,maxErrorCount:5,enabled:!0,onError:e=>{console.error("Failed to get preload status:",e)}});(0,s.useEffect)(()=>{console.log(`%cPetitionLetter Frontend v0.2.0%c
Build: 01/27/2026, 08:56 (New York Time)`,"color: #2563EB; font-size: 14px; font-weight: bold;","color: #64748B; font-size: 12px;"),M(),S()},[S]),(0,s.useEffect)(()=>{i?z():j([])},[i]);let M=async()=>{try{d(!0);let e=await a("/api/projects");n(e||[]),e&&e.length>0&&!i&&o(e[0])}catch(e){console.error("Failed to load projects:",e),R("加载项目失败","error")}finally{d(!1)}},E=async()=>{try{let e;u(!0);let t=await (e=`Project ${l.length+1}`,a("/api/projects",{method:"POST",body:JSON.stringify({name:e})}));n(e=>[t,...e]),o(t),j([]),R("项目已创建","success")}catch(e){console.error("Failed to create project:",e),R("创建项目失败","error")}finally{u(!1)}},B=async e=>{if(confirm("确定要删除此项目吗？此操作无法撤销。"))try{let t;await (t=e,a(`/api/projects/${t}`,{method:"DELETE"})),n(t=>t.filter(t=>t.id!==e)),i?.id===e&&o(l.find(t=>t.id!==e)||null),R("项目已删除","success")}catch(e){console.error("Failed to delete project:",e),R("删除项目失败","error")}},W=async()=>{if(!i||!g.trim())return void p(!1);let e=g.trim();if(e===i.name)return void p(!1);try{let t,s,r=await (t=i.id,s={name:e},a(`/api/projects/${t}`,{method:"PATCH",body:JSON.stringify(s)}));o(r),n(e=>e.map(e=>e.id===i.id?r:e)),R("项目已重命名","success")}catch(e){console.error("Failed to rename project:",e),R("重命名失败","error")}finally{p(!1)}},z=async()=>{if(i)try{let e;N(!0);let t=await (e=i.id,a(`/api/documents/${e}`));j(t.documents||[])}catch(e){console.error("Failed to load documents:",e)}finally{N(!1)}},R=(e,t)=>{L({message:e,type:t})},O=async()=>{await new Promise(e=>setTimeout(e,500)),await z()},P=e=>{R(e,"success")},F=e=>{R(e,"error")};return(0,t.jsxs)("div",{className:"flex h-screen overflow-hidden bg-gray-50",children:[(0,t.jsxs)("aside",{className:`bg-white border-r border-gray-200 flex flex-col transition-all duration-300 ${e?"w-16":"w-72"}`,children:[(0,t.jsxs)("div",{className:"h-16 flex items-center justify-between px-4 border-b border-gray-200",children:[!e&&(0,t.jsx)("h1",{className:"font-semibold text-gray-900 truncate",children:"PetitionLetter"}),(0,t.jsx)("button",{onClick:()=>r(!e),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e?(0,t.jsx)(eE,{}):(0,t.jsx)(eM,{})})]}),(0,t.jsx)("div",{className:"p-3",children:(0,t.jsxs)("button",{onClick:E,disabled:x,className:`w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 ${e?"px-2":""}`,children:[(0,t.jsx)(e_,{}),!e&&(0,t.jsx)("span",{children:"新建项目"})]})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto px-3 pb-3",children:c?(0,t.jsx)("div",{className:"space-y-2",children:[1,2,3].map(e=>(0,t.jsx)("div",{className:"h-12 bg-gray-100 rounded-lg animate-pulse"},e))}):0===l.length?!e&&(0,t.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"暂无项目"}):(0,t.jsx)("div",{className:"space-y-1",children:l.map(s=>(0,t.jsxs)("div",{className:`group flex items-center gap-2 rounded-lg transition-colors ${i?.id===s.id?"bg-blue-50 text-blue-600":"hover:bg-gray-100 text-gray-700"}`,children:[(0,t.jsxs)("button",{onClick:()=>o(s),className:"flex-1 flex items-center gap-3 px-3 py-2.5 text-left",children:[(0,t.jsx)(e$,{}),!e&&(0,t.jsx)("span",{className:"truncate text-sm font-medium",children:s.name})]}),!e&&(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),B(s.id)},className:"p-1.5 mr-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all",children:(0,t.jsx)(eW,{})})]},s.id))})}),(0,t.jsx)("div",{className:"p-3 border-t border-gray-200",children:(0,t.jsxs)("div",{className:`flex items-center gap-2 ${e?"justify-center":""}`,children:[(0,t.jsx)("span",{className:`w-2 h-2 rounded-full ${"online"===w?"bg-green-500":"offline"===w?"bg-red-500":"bg-yellow-500 animate-pulse"}`}),!e&&(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"online"===w?"已连接":"offline"===w?"已断开":"检查中..."})]})})]}),(0,t.jsxs)("main",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,t.jsxs)("header",{className:"h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 flex-shrink-0",children:[(0,t.jsxs)("div",{children:[h?(0,t.jsx)("input",{type:"text",value:g,onChange:e=>b(e.target.value),onBlur:W,onKeyDown:e=>{"Enter"===e.key&&W(),"Escape"===e.key&&p(!1)},autoFocus:!0,className:"font-semibold text-gray-900 bg-gray-100 px-2 py-1 rounded border border-gray-300 focus:outline-none focus:border-blue-500"}):(0,t.jsx)("h2",{className:`font-semibold text-gray-900 ${i?"cursor-pointer hover:text-blue-600":""}`,onClick:i?()=>{i&&(b(i.name),p(!0))}:void 0,title:i?"点击重命名":void 0,children:i?.name||"选择一个项目"}),i&&(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:[f.length," 个文档"]})]}),i&&(0,t.jsxs)("button",{onClick:z,disabled:y,className:"flex items-center gap-2 px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50",children:[(0,t.jsx)(eB,{}),"刷新"]})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-6",children:[$&&!$.is_ready&&(0,t.jsx)("div",{className:"max-w-4xl mx-auto mb-4",children:(0,t.jsx)("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center",children:(0,t.jsxs)("svg",{className:"w-5 h-5 text-amber-600 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-amber-800",children:"模型加载中，请稍候..."}),(0,t.jsxs)("div",{className:"flex gap-4 mt-1 text-xs text-amber-600",children:[(0,t.jsxs)("span",{children:["OCR: ","loaded"===$.models.ocr.status?"✓ 已加载":"loading"===$.models.ocr.status?`加载中 ${$.models.ocr.progress}%`:"error"===$.models.ocr.status?`✗ 错误`:"等待"]}),(0,t.jsxs)("span",{children:["LLM: ","loaded"===$.models.llm.status?"✓ 已加载":"loading"===$.models.llm.status?`加载中 ${$.models.llm.progress}%`:"error"===$.models.llm.status?`✗ 错误`:"等待"]})]})]})]})})}),i?(0,t.jsxs)("div",{className:"max-w-4xl mx-auto space-y-6",children:[(0,t.jsx)(v,{projectId:i.id,documents:f,onUploadComplete:O,onSuccess:P,onError:F}),(0,t.jsx)(_,{projectId:i.id,documents:f,onOCRComplete:()=>{z()},onSuccess:P,onError:F,modelsReady:$?.models?.ocr?.status==="loaded"}),(0,t.jsx)(A,{projectId:i.id,documents:f,onHighlightComplete:()=>{},onSuccess:P,onError:F,modelsReady:$?.models?.llm?.status==="loaded"}),(0,t.jsx)(Z,{projectId:i.id,onSuccess:P,onError:F}),(0,t.jsx)(ed,{projectId:i.id,onSuccess:P,onError:F}),(0,t.jsx)(eS,{projectId:i.id,onSuccess:P,onError:F,modelsReady:$?.models?.llm?.status==="loaded"})]}):(0,t.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 mx-auto mb-4",children:(0,t.jsx)(e$,{})}),(0,t.jsx)("p",{className:"text-lg font-medium text-gray-900",children:"未选择项目"}),(0,t.jsx)("p",{className:"text-gray-500 mt-2",children:"创建或选择一个项目开始使用"}),(0,t.jsx)("button",{onClick:E,className:"mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"创建新项目"})]})})]})]}),C&&(0,t.jsx)(ez,{message:C.message,type:C.type,onClose:()=>L(null)})]})}e.s(["default",()=>eR],52683)}]);