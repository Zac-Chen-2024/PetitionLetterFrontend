(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,67585,(e,t,s)=>{"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"BailoutToCSR",{enumerable:!0,get:function(){return a}});let r=e.r(32061);function a({reason:e,children:t}){if("undefined"==typeof window)throw Object.defineProperty(new r.BailoutToCSRError(e),"__NEXT_ERROR_CODE",{value:"E394",enumerable:!1,configurable:!0});return t}},9885,(e,t,s)=>{"use strict";function r(e){return e.split("/").map(e=>encodeURIComponent(e)).join("/")}Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"encodeURIPath",{enumerable:!0,get:function(){return r}})},52157,(e,t,s)=>{"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"PreloadChunks",{enumerable:!0,get:function(){return i}});let r=e.r(43476),a=e.r(74080),n=e.r(63599),l=e.r(9885);function i({moduleIds:e}){if("undefined"!=typeof window)return null;let t=n.workAsyncStorage.getStore();if(void 0===t)return null;let s=[];if(t.reactLoadableManifest&&e){let r=t.reactLoadableManifest;for(let t of e){if(!r[t])continue;let e=r[t].files;s.push(...e)}}return 0===s.length?null:(0,r.jsx)(r.Fragment,{children:s.map(e=>{let s=`${t.assetPrefix}/_next/${(0,l.encodeURIPath)(e)}`;return e.endsWith(".css")?(0,r.jsx)("link",{precedence:"dynamic",href:s,rel:"stylesheet",as:"style",nonce:t.nonce},e):((0,a.preload)(s,{as:"script",fetchPriority:"low",nonce:t.nonce}),null)})})}},69093,(e,t,s)=>{"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"default",{enumerable:!0,get:function(){return d}});let r=e.r(43476),a=e.r(71645),n=e.r(67585),l=e.r(52157);function i(e){return{default:e&&"default"in e?e.default:e}}let o={loader:()=>Promise.resolve(i(()=>null)),loading:null,ssr:!0},d=function(e){let t={...o,...e},s=(0,a.lazy)(()=>t.loader().then(i)),d=t.loading;function c(e){let i=d?(0,r.jsx)(d,{isLoading:!0,pastDelay:!0,error:null}):null,o=!t.ssr||!!t.loading,c=o?a.Suspense:a.Fragment,x=t.ssr?(0,r.jsxs)(r.Fragment,{children:["undefined"==typeof window?(0,r.jsx)(l.PreloadChunks,{moduleIds:t.modules}):null,(0,r.jsx)(s,{...e})]}):(0,r.jsx)(n.BailoutToCSR,{reason:"next/dynamic",children:(0,r.jsx)(s,{...e})});return(0,r.jsx)(c,{...o?{fallback:i}:{},children:x})}return c.displayName="LoadableComponent",c}},70703,(e,t,s)=>{"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"default",{enumerable:!0,get:function(){return a}});let r=e.r(55682)._(e.r(69093));function a(e,t){let s={};"function"==typeof e&&(s.loader=e);let a={...s,...t};return(0,r.default)({...a,modules:a.loadableGenerated?.modules})}("function"==typeof s.default||"object"==typeof s.default&&null!==s.default)&&void 0===s.default.__esModule&&(Object.defineProperty(s.default,"__esModule",{value:!0}),Object.assign(s.default,s),t.exports=s.default)},52683,e=>{"use strict";e.i(47167);var t=e.i(43476),s=e.i(71645);let r="https://petigen.zacchen.win";async function a(e,t){let s=`${r}${e}`,a=await fetch(s,{...t,headers:{"Content-Type":"application/json",...t?.headers}});if(!a.ok)throw Error(await a.text()||`API error: ${a.status}`);return a.json()}let n=async(e,t,s,a,n,l)=>{let i=await fetch(`${r}/api/upload/init`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:e,file_name:t,file_size:s,total_chunks:a,exhibit_number:n||null,exhibit_title:l||null})});if(!i.ok)throw Error(`Init upload failed: ${i.status}`);return i.json()},l=async(e,t,s)=>{let a=new FormData;a.append("chunk",s);let n=await fetch(`${r}/api/upload/chunk/${e}/${t}`,{method:"POST",body:a});if(!n.ok)throw Error(`Chunk upload failed: ${n.status}`);return n.json()},i=async e=>{let t=await fetch(`${r}/api/upload/complete/${e}`,{method:"POST"});if(!t.ok)throw Error(`Complete upload failed: ${t.status}`);return t.json()},o=async e=>{await fetch(`${r}/api/upload/cancel/${e}`,{method:"DELETE"})};async function d(e,t,s,r,a){let d=Math.ceil(t.size/5242880),{upload_id:c}=await n(e,t.name,t.size,d,s,r);try{for(let e=0;e<d;e++){let s=5242880*e,r=Math.min(s+5242880,t.size),n=t.slice(s,r);await l(c,e,n);let i=Math.round((e+1)/d*100);a?.(i)}return await i(c)}catch(e){try{await o(c)}catch{}throw e}}let c=e=>a(`/api/l1-summary/${e}`),x=(e,t)=>{let s=t?`?page=${t}`:"";return a(`/api/highlight/${e}${s}`)},u=e=>a(`/api/highlight/progress/${e}`);function h(e){let{fetcher:t,shouldContinue:r,interval:a=2e3,errorRetryInterval:n=5e3,maxErrorCount:l=3,maxDuration:i,enabled:o=!1,onSuccess:d,onError:c,onTimeout:x,onMaxErrors:u}=e,[h,m]=(0,s.useState)(null),[p,g]=(0,s.useState)(null),[y,b]=(0,s.useState)(!1),[f,j]=(0,s.useState)(0),v=(0,s.useRef)(!1),N=(0,s.useRef)(0),w=(0,s.useRef)(null),k=(0,s.useRef)(null),C=(0,s.useRef)(null),L=(0,s.useRef)(!0),S=(0,s.useRef)(d),$=(0,s.useRef)(c),_=(0,s.useRef)(x),M=(0,s.useRef)(u),E=(0,s.useRef)(t),B=(0,s.useRef)(r);(0,s.useEffect)(()=>{S.current=d,$.current=c,_.current=x,M.current=u,E.current=t,B.current=r},[d,c,x,u,t,r]);let F=(0,s.useCallback)(()=>{w.current&&(clearTimeout(w.current),w.current=null),k.current&&(clearTimeout(k.current),k.current=null)},[]),z=(0,s.useCallback)(()=>{v.current=!1,b(!1),F(),C.current=null},[F]),W=(0,s.useCallback)(()=>{z(),m(null),g(null),j(0),N.current=0},[z]),P=(0,s.useCallback)(async()=>{if(v.current&&L.current)try{let e=await E.current();if(!L.current)return;N.current=0,j(0),g(null),m(e),S.current?.(e),B.current(e)&&v.current?w.current=setTimeout(P,a):z()}catch(s){if(!L.current)return;let e=s instanceof Error?s:Error(String(s));g(e),N.current+=1;let t=N.current;j(t),$.current?.(e),t>=l?(M.current?.(),z()):v.current&&(w.current=setTimeout(P,n))}},[a,n,l,z]),A=(0,s.useCallback)(()=>{v.current||(N.current=0,j(0),g(null),v.current=!0,b(!0),C.current=Date.now(),i&&(k.current=setTimeout(()=>{L.current&&v.current&&(_.current?.(),z())},i)),P())},[P,i,z]);return(0,s.useEffect)(()=>{o&&A()},[o]),(0,s.useEffect)(()=>(L.current=!0,()=>{L.current=!1,F()}),[F]),{data:h,error:p,isPolling:y,errorCount:f,start:A,stop:z,reset:W}}var m=e.i(81917);let p=["A","B","C","D","E","F","G","H"],g=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),y=()=>(0,t.jsx)("svg",{className:"w-8 h-8",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})}),b=()=>(0,t.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),f=()=>(0,t.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M6 18L18 6M6 6l12 12"})}),j=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),v=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})});function N({projectId:e,documents:r,onUploadComplete:a,onError:n,onSuccess:l}){let{t:i}=(0,m.useLanguage)(),[o,c]=(0,s.useState)([]),[x,u]=(0,s.useState)(!1),[h,N]=(0,s.useState)("A"),[w,k]=(0,s.useState)(!1),C=(0,s.useRef)(null),L=(0,s.useMemo)(()=>r.map(e=>{let t=e.exhibit_number||"N/A",s=t.split("-")[0]||"A";return{id:e.id,fileName:e.file_name,exhibitNumber:t,exhibitFolder:s,status:"completed",progress:100,isUploading:!1}}),[r]),S=(0,s.useMemo)(()=>o.map(e=>({id:e.id,fileName:e.file.name,exhibitNumber:e.exhibitNumber,exhibitFolder:e.exhibitFolder,status:e.status,progress:e.progress,isUploading:!0,error:e.error})),[o]),$=(0,s.useMemo)(()=>{let e=[...L],t=new Set(L.map(e=>e.exhibitNumber));for(let s of S)t.has(s.exhibitNumber)||e.push(s);return e},[L,S]),_=(0,s.useMemo)(()=>{let e={};return p.forEach(t=>{e[t]=$.filter(e=>e.exhibitFolder===t)}),e},[$]),M=(0,s.useCallback)(e=>{let t=$.filter(t=>t.exhibitFolder===e);return 0===t.length?1:Math.max(...t.map(e=>{let t=e.exhibitNumber.match(/-(\d+)$/);return t?parseInt(t[1]):0}))+1},[$]),E=w?"uploading":o.some(e=>"completed"===e.status)?"completed":"idle",B=(0,s.useCallback)(e=>{if(!e||0===e.length)return;let t=[],s=M(h);for(let r=0;r<e.length;r++){let a=e[r];(["application/pdf","image/png","image/jpeg","image/jpg","image/tiff"].includes(a.type)||a.name.match(/\.(pdf|png|jpg|jpeg|tiff?)$/i))&&(t.push({id:`${Date.now()}-${r}`,file:a,exhibitNumber:`${h}-${s}`,exhibitFolder:h,status:"pending",progress:0}),s++)}t.length>0&&c(e=>[...e,...t])},[h,M]),F=async()=>{let t=o.filter(e=>"pending"===e.status);if(0===t.length)return;k(!0);let s=0,r=0;for(let a of t){let t=a.id;c(e=>e.map(e=>e.id===t?{...e,status:"uploading",progress:0}:e));try{await d(e,a.file,a.exhibitNumber,a.file.name.replace(/\.[^/.]+$/,""),e=>{c(s=>s.map(s=>s.id===t?{...s,progress:e}:s))}),c(e=>e.map(e=>e.id===t?{...e,status:"completed",progress:100}:e)),s++}catch(e){c(s=>s.map(s=>s.id===t?{...s,status:"failed",error:e.message}:s)),r++}}k(!1),s>0&&(l(`${s} ${i.upload.success}`),a()),r>0&&n(`${r} ${i.upload.failed}`)},z=_[h]||[],W=o.filter(e=>"pending"===e.status).length,P=$.length;return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600",children:(0,t.jsx)(g,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:i.upload.title}),P>0&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[P," ",i.upload.files]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[W>0&&(0,t.jsxs)("button",{onClick:F,disabled:w,className:"flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[(0,t.jsx)(g,{}),i.upload.uploadButton," (",W,")"]}),(0,t.jsx)(({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:i.upload.status.idle},uploading:{bg:"bg-blue-100",text:"text-blue-700",label:i.upload.status.uploading},completed:{bg:"bg-green-100",text:"text-green-700",label:i.upload.status.completed}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},{status:E})]})]})}),(0,t.jsxs)("div",{className:"flex",style:{minHeight:"300px"},children:[(0,t.jsxs)("div",{className:"w-64 border-r border-gray-200 flex flex-col",children:[(0,t.jsx)("div",{className:"px-2 py-2 border-b border-gray-100 bg-gray-50",children:(0,t.jsx)("div",{className:"flex flex-wrap gap-1",children:p.map(e=>{let s=_[e]?.length||0;return(0,t.jsxs)("button",{onClick:()=>N(e),className:`relative px-3 py-1.5 text-xs font-medium rounded transition-colors ${h===e?"bg-blue-600 text-white":"bg-white text-gray-700 hover:bg-gray-100 border border-gray-200"}`,children:[e,s>0&&(0,t.jsx)("span",{className:`absolute -top-1 -right-1 w-4 h-4 text-xs rounded-full flex items-center justify-center ${h===e?"bg-white text-blue-600":"bg-blue-500 text-white"}`,children:s})]},e)})})}),(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 flex items-center justify-between",children:[(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-600",children:["Exhibit ",h," (",z.length,")"]}),z.length>0&&(0,t.jsx)("button",{onClick:()=>{c(e=>e.filter(e=>e.exhibitFolder!==h))},className:"text-xs text-gray-400 hover:text-red-500 transition-colors",children:i.common.clear})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===z.length?(0,t.jsxs)("div",{className:"p-4 text-center text-xs text-gray-400",children:[i.upload.noFiles,(0,t.jsx)("p",{className:"mt-1",children:i.upload.dragOrClick})]}):(0,t.jsx)("div",{className:"py-1",children:z.map(e=>(0,t.jsxs)("div",{className:`flex items-center gap-2 px-3 py-2 border-b border-gray-50 ${"completed"===e.status?"bg-green-50":"failed"===e.status?"bg-red-50":"uploading"===e.status?"bg-blue-50":"hover:bg-gray-50"}`,children:[(0,t.jsx)("div",{className:"flex-shrink-0 w-4 h-4 flex items-center justify-center",children:"uploading"===e.status?(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}):"completed"===e.status?(0,t.jsx)("div",{className:"w-3 h-3 bg-green-500 rounded-full flex items-center justify-center",children:(0,t.jsx)(b,{})}):"failed"===e.status?(0,t.jsx)("div",{className:"w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white",children:(0,t.jsx)(f,{})}):(0,t.jsx)("div",{className:"text-gray-400",children:(0,t.jsx)(j,{})})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 truncate",children:e.exhibitNumber}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:e.fileName,children:e.fileName}),"uploading"===e.status&&(0,t.jsx)("div",{className:"mt-1 h-1 bg-gray-200 rounded-full overflow-hidden",children:(0,t.jsx)("div",{className:"h-full bg-blue-500 rounded-full transition-all duration-300",style:{width:`${e.progress}%`}})})]}),(0,t.jsx)("div",{className:"flex-shrink-0",children:"uploading"===e.status?(0,t.jsxs)("span",{className:"text-xs text-blue-600",children:[e.progress,"%"]}):"pending"===e.status&&e.isUploading?(0,t.jsx)("button",{onClick:()=>{var t;return t=e.id,void c(e=>e.filter(e=>e.id!==t))},className:"p-1 text-gray-400 hover:text-red-600 transition-colors",children:(0,t.jsx)(v,{})}):null})]},e.id))})})]}),(0,t.jsx)("div",{className:"flex-1 p-4 flex items-center justify-center",children:(0,t.jsxs)("div",{onDragOver:e=>{e.preventDefault(),u(!0)},onDragLeave:e=>{e.preventDefault(),u(!1)},onDrop:e=>{e.preventDefault(),u(!1),B(e.dataTransfer.files)},onClick:()=>C.current?.click(),className:`w-full h-full border-2 border-dashed rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all ${x?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-400 hover:bg-gray-50"}`,children:[(0,t.jsx)("input",{ref:C,type:"file",multiple:!0,accept:".pdf,.png,.jpg,.jpeg,.tiff,.tif",onChange:e=>B(e.target.files),className:"hidden"}),(0,t.jsx)("div",{className:`mb-3 ${x?"text-blue-500":"text-gray-400"}`,children:(0,t.jsx)(y,{})}),(0,t.jsx)("p",{className:"text-sm font-medium text-gray-700",children:i.upload.dragHere}),(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:i.upload.supportedFormats}),(0,t.jsxs)("p",{className:"text-xs text-blue-600 mt-3 font-medium",children:[i.upload.currentTarget,": Exhibit ",h]})]})})]})]})}function w({url:e,onMessage:t,onComplete:r,onError:a,autoConnect:n=!1}){let[l,i]=(0,s.useState)(!1),[o,d]=(0,s.useState)(null),c=(0,s.useRef)(null),x=(0,s.useRef)(!0),u=(0,s.useRef)(t),h=(0,s.useRef)(r),m=(0,s.useRef)(a);(0,s.useEffect)(()=>{u.current=t,h.current=r,m.current=a},[t,r,a]);let p=(0,s.useCallback)(()=>{c.current&&(c.current.close(),c.current=null),x.current&&i(!1)},[]),g=(0,s.useCallback)(()=>{if(!e)return;c.current&&c.current.close();let t=new EventSource(e);c.current=t,t.onopen=()=>{x.current&&i(!0)},t.onmessage=e=>{if(x.current)try{let t=JSON.parse(e.data);d(t),u.current?.(t)}catch(e){console.error("[useSSE] Failed to parse message:",e)}},t.addEventListener("progress",e=>{if(x.current)try{let t=JSON.parse(e.data);d(t),u.current?.(t)}catch(e){console.error("[useSSE] Failed to parse progress event:",e)}}),t.addEventListener("complete",e=>{if(x.current)try{let t=JSON.parse(e.data);d(t),h.current?.(t),p()}catch(e){console.error("[useSSE] Failed to parse complete event:",e)}}),t.onerror=e=>{x.current&&(console.error("[useSSE] Connection error:",e),m.current?.(e),i(!1))}},[e,p]);return(0,s.useEffect)(()=>{n&&e&&g()},[n,e,g]),(0,s.useEffect)(()=>(x.current=!0,()=>{x.current=!1,c.current&&(c.current.close(),c.current=null)}),[]),(0,s.useEffect)(()=>{!e&&c.current&&p()},[e,p]),{isConnected:l,lastData:o,connect:g,disconnect:p}}let k="undefined"!=typeof EventSource,C=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"})}),L=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),S=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),$=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),_=({status:e,t:s})=>{switch(e){case"pending":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-gray-300 flex-shrink-0",title:s.ocr.pending});case"queued":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-yellow-400 flex-shrink-0",title:s.ocr.queued});case"processing":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse flex-shrink-0",title:s.ocr.processing});case"completed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-green-500 flex-shrink-0",title:s.ocr.status.completed});case"failed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-red-500 flex-shrink-0",title:s.ocr.failed})}};function M({projectId:e,documents:n,onOCRComplete:l,onSuccess:i,onError:o,modelsReady:d=!0}){let c,{t:x}=(0,m.useLanguage)(),[u,p]=(0,s.useState)([]),[g,y]=(0,s.useState)(null),[b,f]=(0,s.useState)(""),[j,v]=(0,s.useState)(!1),[N,M]=(0,s.useState)(!1),[E,B]=(0,s.useState)(null),F=e?(c=e,`${r}/api/ocr/stream/${c}`):null,z=(0,s.useCallback)(e=>{e.current_processing?B({documentId:e.current_processing.document_id,fileName:e.current_processing.file_name,currentPage:e.current_processing.current_page,totalPages:e.current_processing.total_pages}):B(null),p(t=>t.map(t=>{let s=e.documents?.find(e=>e.id===t.id);return s?{...t,status:s.ocr_status}:t}))},[]),W=(0,s.useCallback)(e=>{M(!1),B(null),l(),e.failed>0?o(`${x.ocr.ocrComplete}: ${e.completed} ${x.common.success}, ${e.failed} ${x.ocr.failed}`):e.completed>0&&i(`${x.ocr.ocrComplete}: ${e.completed} ${x.l1Analysis.documents}`)},[l,o,i,x]),{isConnected:P,connect:A,disconnect:T}=w({url:k?F:null,onMessage:z,onComplete:W,onError:e=>{console.error("[OCR SSE] Connection error:",e)}}),{isPolling:O,errorCount:R,start:D,stop:H}=h({fetcher:()=>{let t;return t=e,a(`/api/ocr/progress/${t}`)},shouldContinue:e=>e.processing>0||e.pending>0||e.queued>0,interval:2e3,errorRetryInterval:5e3,maxErrorCount:3,maxDuration:18e5,enabled:!1,onSuccess:e=>{z(e),0===e.processing&&0===e.pending&&0===e.queued&&W(e)},onError:e=>{console.error("Failed to get OCR progress:",e)},onMaxErrors:()=>{M(!1),o(x.backend.cannotConnect),p(e=>e.map(e=>"processing"===e.status||"queued"===e.status?{...e,status:"pending"}:e))},onTimeout:()=>{M(!1),o(x.ocr.timeout),p(e=>e.map(e=>"processing"===e.status||"queued"===e.status?{...e,status:"pending"}:e))}}),q=(0,s.useCallback)(()=>{M(!0),k?A():D()},[A,D]);(0,s.useCallback)(()=>{M(!1),k?T():H()},[T,H]),(0,s.useEffect)(()=>{let e=n.map(e=>({id:e.id,fileName:e.file_name,exhibitNumber:e.exhibit_number||"N/A",status:e.ocr_status||"pending",ocrText:e.ocr_text}));if(p(e),!g){let t=e.find(e=>"completed"===e.status);t&&(y(t.id),f(t.ocrText||""))}},[n,g]);let V=N||u.some(e=>"processing"===e.status)?"processing":u.length>0&&u.every(e=>"completed"===e.status)?"completed":"idle",I=u.filter(e=>"pending"===e.status).length,J=u.filter(e=>"completed"===e.status).length,U=async e=>{try{let t;p(t=>t.map(t=>t.id===e?{...t,status:"processing"}:t)),await (t=e,a(`/api/ocr/${t}`,{method:"POST"})),q()}catch(t){console.error("OCR failed:",t),o(t instanceof Error&&t.message.includes("fetch")?x.backend.cannotConnect:x.ocr.ocrFailed),p(t=>t.map(t=>t.id===e?{...t,status:"pending"}:t))}},Q=async()=>{if(0!==I)try{let t;p(e=>e.map(e=>"pending"===e.status?{...e,status:"queued"}:e)),await (t=e,a(`/api/ocr/batch/${t}`,{method:"POST"})),i(x.ocr.ocrComplete),q()}catch(e){console.error("Batch OCR failed:",e),o(e instanceof Error&&e.message.includes("fetch")?x.backend.cannotConnect:x.ocr.batchFailed),p(e=>e.map(e=>"queued"===e.status?{...e,status:"pending"}:e))}},K=e=>{y(e.id),f(e.ocrText||"")},G=u.find(e=>e.id===g);return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600",children:(0,t.jsx)(C,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:x.ocr.title}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[J,"/",u.length," ",x.ocr.completed]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("button",{onClick:Q,disabled:0===I||N||!d,className:"flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-xs font-medium rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:d?void 0:x.backend.modelsLoading,children:[(0,t.jsx)(L,{}),d?x.ocr.startAll:x.backend.modelsLoading]}),(0,t.jsx)(({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:x.ocr.status.idle},processing:{bg:"bg-blue-100",text:"text-blue-700",label:x.ocr.status.processing},completed:{bg:"bg-green-100",text:"text-green-700",label:x.ocr.status.completed}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},{status:V})]})]})}),(0,t.jsxs)("div",{className:"flex",style:{height:"500px"},children:[(0,t.jsxs)("div",{className:`border-r border-gray-200 flex flex-col transition-all duration-300 ${j?"w-10":"w-64"}`,children:[(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[!j&&(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:x.ocr.fileList}),(0,t.jsx)("button",{onClick:()=>v(!j),className:"p-1 hover:bg-gray-200 rounded transition-colors",title:j?x.common.expand:x.common.collapse,children:j?(0,t.jsx)($,{}):(0,t.jsx)(S,{})})]}),j?(0,t.jsx)("div",{className:"flex-1 overflow-y-auto py-1",children:u.map(e=>(0,t.jsx)("div",{onClick:()=>"completed"===e.status&&K(e),className:`flex items-center justify-center py-2 cursor-pointer transition-colors ${g===e.id?"bg-purple-50":"hover:bg-gray-50"}`,title:`${e.exhibitNumber}: ${e.fileName}`,children:(0,t.jsx)(_,{status:e.status,t:x})},e.id))}):(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===u.length?(0,t.jsx)("div",{className:"p-4 text-center text-xs text-gray-400",children:x.ocr.noFiles}):(0,t.jsx)("div",{className:"py-1",children:u.map(e=>(0,t.jsxs)("div",{onClick:()=>"completed"===e.status&&K(e),className:`px-3 py-2 cursor-pointer transition-colors ${g===e.id?"bg-purple-50 border-r-2 border-purple-500":"hover:bg-gray-50"} ${"completed"!==e.status?"opacity-60":""}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(_,{status:e.status,t:x}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 truncate",children:e.exhibitNumber}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:e.fileName,children:e.fileName})]}),"pending"===e.status&&!N&&d&&(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),U(e.id)},className:"px-1.5 py-0.5 text-xs text-purple-600 hover:bg-purple-100 rounded transition-colors",children:x.ocr.start})]}),E?.documentId===e.id&&E.totalPages>0&&(0,t.jsxs)("div",{className:"mt-2",children:[(0,t.jsxs)("div",{className:"flex justify-between text-xs text-gray-500 mb-1",children:[(0,t.jsxs)("span",{children:[x.ocr.page," ",E.currentPage,"/",E.totalPages]}),(0,t.jsxs)("span",{children:[Math.round(E.currentPage/E.totalPages*100),"%"]})]}),(0,t.jsx)("div",{className:"h-1.5 bg-gray-200 rounded-full overflow-hidden",children:(0,t.jsx)("div",{className:"h-full bg-purple-500 transition-all duration-300",style:{width:`${E.currentPage/E.totalPages*100}%`}})})]})]},e.id))})})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,t.jsxs)("div",{className:"px-4 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:G?`${x.ocr.result} - ${G.exhibitNumber}: ${G.fileName}`:x.ocr.resultPreview}),b&&(0,t.jsx)("button",{onClick:async()=>{try{await navigator.clipboard.writeText(b)}catch(e){console.error("Failed to copy:",e)}},className:"text-xs text-gray-500 hover:text-gray-700 px-2 py-1 hover:bg-gray-200 rounded transition-colors",children:x.common.copy})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-4 bg-white",children:b?(0,t.jsx)("div",{className:"prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap font-mono text-sm leading-relaxed",children:b}):(0,t.jsx)("div",{className:"h-full flex items-center justify-center text-gray-400",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,t.jsx)("p",{className:"text-sm",children:x.ocr.selectCompleted})]})})})]})]})]})}let E=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),B=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),F=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),z=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"})}),W=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"})}),P={key_fact:"rgba(59, 130, 246, 0.3)",evidence:"rgba(16, 185, 129, 0.3)",timeline:"rgba(245, 158, 11, 0.3)",entity:"rgba(139, 92, 246, 0.3)",financial:"rgba(236, 72, 153, 0.3)",default:"rgba(251, 191, 36, 0.3)"};function A({documentId:e,pageCount:a=1,currentPage:n,onPageChange:l,selectedHighlightId:i}){let{t:o}=(0,m.useLanguage)(),[d,c]=(0,s.useState)(1),u=n??d,h=e=>{l?l(e):c(e)},[p,g]=(0,s.useState)(a),[y,b]=(0,s.useState)(null),[f,j]=(0,s.useState)([]),[v,N]=(0,s.useState)(!1),[w,k]=(0,s.useState)(null),[C,L]=(0,s.useState)(100),[S,$]=(0,s.useState)(null),[_,M]=(0,s.useState)(null);return((0,s.useEffect)(()=>{if(i){let e=f.find(e=>e.id===i);e&&$(e)}},[i,f]),(0,s.useEffect)(()=>{if(!e){b(null),j([]);return}(async()=>{N(!0),k(null),M(null);try{var t,s;let a,n=(t=e,s=u,a="",`${r}/api/highlight/page/${t}/${s}/image${a}`);b(n);let l=await x(e,u);j(l.highlights||[])}catch(e){console.error("Failed to load page data:",e),k(o.pdfViewer.loadFailed),b(null),j([])}finally{N(!1)}})()},[e,u]),(0,s.useEffect)(()=>{g(a)},[a]),(0,s.useEffect)(()=>{n||c(1),$(null)},[e,n]),e)?(0,t.jsxs)("div",{className:"h-full flex flex-col border border-gray-200 rounded-lg overflow-hidden bg-white",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 bg-gray-50 border-b border-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("button",{onClick:()=>{L(e=>Math.max(e-25,50))},disabled:C<=50,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:o.pdfViewer.zoomOut,children:(0,t.jsx)(W,{})}),(0,t.jsxs)("span",{className:"text-xs text-gray-600 min-w-[40px] text-center",children:[C,"%"]}),(0,t.jsx)("button",{onClick:()=>{L(e=>Math.min(e+25,200))},disabled:C>=200,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:o.pdfViewer.zoomIn,children:(0,t.jsx)(z,{})})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>{u>1&&(h(u-1),$(null))},disabled:u<=1,className:"p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,t.jsx)(E,{})}),(0,t.jsxs)("span",{className:"text-sm text-gray-700 min-w-[60px] text-center",children:[u," / ",p]}),(0,t.jsx)("button",{onClick:()=>{u<p&&(h(u+1),$(null))},disabled:u>=p,className:"p-1 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,t.jsx)(B,{})})]}),(0,t.jsx)("button",{onClick:()=>{y&&window.open(y,"_blank")},className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded transition-colors",title:o.pdfViewer.downloadPage,children:(0,t.jsx)(F,{})})]}),(0,t.jsx)("div",{className:"flex-1 overflow-auto bg-gray-100 relative",children:v?(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-8 h-8 border-3 border-blue-500 border-t-transparent rounded-full animate-spin"})}):w?(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-sm text-red-500",children:w})}):y?(0,t.jsx)("div",{className:"min-h-full flex items-start justify-center p-4",children:(0,t.jsxs)("div",{className:"relative shadow-lg bg-white",style:{transform:`scale(${C/100})`,transformOrigin:"top center"},children:[(0,t.jsx)("img",{src:y,alt:`Page ${u}`,className:"block",style:{maxWidth:"none"},onLoad:e=>{let t=e.target;M({width:t.naturalWidth,height:t.naturalHeight})},onError:()=>k(o.pdfViewer.imageFailed)}),_&&f.map((e,s)=>{var r;let a,n,l;if(!e.bbox||null==e.bbox.x1)return null;let{x1:i,y1:d,x2:c,y2:x}=e.bbox,u=(a={x1:i||0,y1:d||0,x2:c||0,y2:x||0},n=_.width,l=_.height,{left:a.x1/1e3*n,top:a.y1/1e3*l,width:(a.x2-a.x1)/1e3*n,height:(a.y2-a.y1)/1e3*l});return u.width<=0||u.height<=0?null:(0,t.jsx)("div",{className:`absolute cursor-pointer transition-all ${S?.id===e.id?"ring-2 ring-blue-500":"hover:ring-2 hover:ring-blue-300"}`,style:{left:`${u.left}px`,top:`${u.top}px`,width:`${u.width}px`,height:`${u.height}px`,backgroundColor:(r=e.category)&&P[r.toLowerCase()]||P.default,borderRadius:"2px"},onClick:()=>$(e),title:e.text_content||o.highlight.highlightArea},e.id||s)})]})}):(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center",children:(0,t.jsx)("p",{className:"text-sm text-gray-500",children:o.pdfViewer.loadFailed})})}),S&&(0,t.jsx)("div",{className:"px-4 py-3 bg-blue-50 border-t border-blue-200",children:(0,t.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[S.category&&(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs font-medium rounded bg-blue-100 text-blue-700",children:S.category_cn||S.category}),S.importance&&(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${"high"===S.importance?"bg-red-100 text-red-700":"medium"===S.importance?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-700"}`,children:"high"===S.importance?o.pdfViewer.highImportance:"medium"===S.importance?o.pdfViewer.mediumImportance:o.pdfViewer.lowImportance})]}),(0,t.jsx)("p",{className:"text-sm text-gray-800 line-clamp-2",children:S.text_content||o.highlight.noTextContent}),S.reason&&(0,t.jsxs)("p",{className:"text-xs text-gray-600 mt-1 line-clamp-1",children:[(0,t.jsxs)("span",{className:"font-medium",children:[o.pdfViewer.reason,":"]})," ",S.reason]})]}),(0,t.jsx)("button",{onClick:()=>$(null),className:"p-1 text-gray-400 hover:text-gray-600 transition-colors flex-shrink-0",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),f.length>0&&(0,t.jsxs)("div",{className:"px-3 py-1.5 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 text-center",children:[o.highlight.currentPage," ",f.length," ",o.highlight.highlightAreas]})]}):(0,t.jsx)("div",{className:"h-full flex items-center justify-center bg-gray-50 rounded-lg border border-gray-200",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),(0,t.jsx)("p",{className:"text-sm text-gray-500",children:o.pdfViewer.selectFile})]})})}let T="undefined"!=typeof EventSource,O=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),R=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),D=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),H=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),q=({status:e,t:s})=>{switch(e){case"not_started":case"pending":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-gray-300 flex-shrink-0",title:s.highlight.pending});case"processing":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse flex-shrink-0",title:s.highlight.status.processing});case"completed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-green-500 flex-shrink-0",title:s.highlight.status.completed});case"failed":return(0,t.jsx)("span",{className:"w-2.5 h-2.5 rounded-full bg-red-500 flex-shrink-0",title:s.ocr.failed})}};function V({projectId:e,documents:n,onHighlightComplete:l,onSuccess:i,onError:o,modelsReady:d=!0}){let c,{t:p}=(0,m.useLanguage)(),[g,y]=(0,s.useState)([]),[b,f]=(0,s.useState)(null),[j,v]=(0,s.useState)(!1),[N,k]=(0,s.useState)(!1),[C,L]=(0,s.useState)(!1),[S,$]=(0,s.useState)([]),[_,M]=(0,s.useState)(!1),[E,B]=(0,s.useState)(1),[F,z]=(0,s.useState)(null),W=(0,s.useRef)(!1),P=(0,s.useRef)(!1),V=e?(c=e,`${r}/api/highlight/stream/${c}`):null,I=(0,s.useCallback)(e=>{y(t=>{let s=!1,r=t.map(t=>{let r=e.documents?.find(e=>e.id===t.id);if(r){let e=r.highlight_status||"pending";if(t.status!==e)return s=!0,{...t,status:e}}return t});return s?r:t})},[]),J=(0,s.useCallback)(e=>{L(!1),l(),e.failed>0?o(`${p.highlight.analysisComplete}: ${e.completed} ${p.common.success}, ${e.failed} ${p.ocr.failed}`):e.completed>0&&i(`${p.highlight.analysisComplete}: ${e.completed} ${p.l1Analysis.documents}`)},[l,o,i,p]),{isConnected:U,connect:Q,disconnect:K}=w({url:T?V:null,onMessage:I,onComplete:J,onError:e=>{console.error("[Highlight SSE] Connection error:",e)}}),{isPolling:G,errorCount:Y,start:X,stop:Z}=h({fetcher:()=>u(e),shouldContinue:e=>e.processing>0||e.pending>0,interval:2e3,errorRetryInterval:5e3,maxErrorCount:3,maxDuration:18e5,enabled:!1,onSuccess:e=>{I(e),0===e.processing&&0===e.pending&&J(e)},onError:e=>{console.error("Failed to get highlight progress:",e)},onMaxErrors:()=>{L(!1),o(p.backend.cannotConnect),y(e=>e.map(e=>"processing"===e.status?{...e,status:"pending"}:e))},onTimeout:()=>{L(!1),o(p.highlight.timeout),y(e=>e.map(e=>"processing"===e.status?{...e,status:"pending"}:e))}}),ee=(0,s.useCallback)(()=>{L(!0),T?Q():X()},[Q,X]);(0,s.useCallback)(()=>{L(!1),T?K():Z()},[K,Z]);let et=(0,s.useMemo)(()=>n.filter(e=>"completed"===e.ocr_status).map(e=>e.id).sort().join(","),[n]);(0,s.useEffect)(()=>{let e=n.filter(e=>"completed"===e.ocr_status);y(t=>{let s=new Set(t.map(e=>e.id)),r=new Set(e.map(e=>e.id));return s.size===r.size&&[...s].every(e=>r.has(e))?t:e.map(e=>{let s=t.find(t=>t.id===e.id);return{id:e.id,fileName:e.file_name,exhibitNumber:e.exhibit_number||"N/A",status:s?.status||"pending",pageCount:e.page_count||1}})})},[et,n]),(0,s.useEffect)(()=>{!b&&g.length>0&&f(g[0])},[b,g]);let es=(0,s.useMemo)(()=>b?g.find(e=>e.id===b.id)?.status??null:null,[g,b?.id]);(0,s.useEffect)(()=>{b&&es&&es!==b.status&&f(e=>e?{...e,status:es}:null)},[es,b?.status]),(0,s.useEffect)(()=>{W.current=!1},[e]),(0,s.useEffect)(()=>{(async()=>{if(!W.current&&0!==g.length){W.current=!0;try{let t=await u(e);y(e=>{let s=!1,r=e.map(e=>{let r=t.documents?.find(t=>t.id===e.id);if(r){let t=r.highlight_status||"pending";if(e.status!==t)return s=!0,{...e,status:t,pageCount:r.page_count||e.pageCount}}return e});return s?r:e})}catch(e){console.error("Failed to load highlight status:",e)}}})()},[e,g.length]);let er=C||g.some(e=>"processing"===e.status)?"processing":g.length>0&&g.every(e=>"completed"===e.status)?"completed":"idle",ea=g.filter(e=>"pending"===e.status||"not_started"===e.status).length,en=g.filter(e=>"completed"===e.status).length,el=async e=>{try{let t;y(t=>t.map(t=>t.id===e.id?{...t,status:"processing"}:t)),await (t=e.id,a(`/api/highlight/${t}`,{method:"POST"})),ee()}catch(t){console.error("Highlight failed:",t),o(t instanceof Error&&t.message.includes("fetch")?p.backend.cannotConnect:p.highlight.analysisFailed),y(t=>t.map(t=>t.id===e.id?{...t,status:"pending"}:t))}},ei=async()=>{if(0!==ea)try{let t;y(e=>e.map(e=>"pending"===e.status||"not_started"===e.status?{...e,status:"processing"}:e)),await (t=e,a(`/api/highlight/batch/${t}`,{method:"POST"})),i(p.highlight.analysisComplete),ee()}catch(e){console.error("Batch highlight failed:",e),o(e instanceof Error&&e.message.includes("fetch")?p.backend.cannotConnect:p.highlight.batchFailed),y(e=>e.map(e=>"processing"===e.status?{...e,status:"pending"}:e))}},eo=g.find(e=>e.id===b?.id)?.status;(0,s.useEffect)(()=>{(async()=>{if(!b||"completed"!==eo)return $([]);if(!P.current){P.current=!0,M(!0);try{let e=await x(b.id);$(e.highlights||[])}catch(e){console.error("Failed to load highlights:",e),$([])}finally{M(!1),P.current=!1}}})(),B(1),z(null)},[b?.id,eo]);let ed=e=>{f(e)};return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center text-yellow-600",children:(0,t.jsx)(O,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:p.highlight.title}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[en,"/",g.length," ",p.highlight.completed]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("button",{onClick:ei,disabled:0===ea||C||!d,className:"flex items-center gap-1.5 px-3 py-1.5 bg-yellow-500 text-white text-xs font-medium rounded-lg hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:d?void 0:p.backend.modelsLoading,children:[(0,t.jsx)(R,{}),d?p.highlight.analyzeAll:p.backend.modelsLoading]}),(0,t.jsx)(({status:e})=>{let{bg:s,text:r,label:a}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:p.highlight.status.idle},processing:{bg:"bg-yellow-100",text:"text-yellow-700",label:p.highlight.status.processing},completed:{bg:"bg-green-100",text:"text-green-700",label:p.highlight.status.completed}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${s} ${r}`,children:a})},{status:er})]})]})}),(0,t.jsxs)("div",{className:"flex",style:{height:"500px"},children:[(0,t.jsxs)("div",{className:`border-r border-gray-200 flex flex-col transition-all duration-300 ${j?"w-10":"w-56"}`,children:[(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[!j&&(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:p.highlight.fileList}),(0,t.jsx)("button",{onClick:()=>v(!j),className:"p-1 hover:bg-gray-200 rounded transition-colors",title:j?p.common.expand:p.common.collapse,children:j?(0,t.jsx)(H,{}):(0,t.jsx)(D,{})})]}),j?(0,t.jsx)("div",{className:"flex-1 overflow-y-auto py-1",children:g.map(e=>(0,t.jsx)("div",{onClick:()=>ed(e),className:`flex items-center justify-center py-2 cursor-pointer transition-colors ${b?.id===e.id?"bg-yellow-50":"hover:bg-gray-50"}`,title:`${e.exhibitNumber}: ${e.fileName}`,children:(0,t.jsx)(q,{status:e.status,t:p})},e.id))}):(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===g.length?(0,t.jsxs)("div",{className:"p-4 text-center text-xs text-gray-400",children:[p.highlight.noFiles,(0,t.jsx)("p",{className:"mt-1",children:p.highlight.completeOcrFirst})]}):(0,t.jsx)("div",{className:"py-1",children:g.map(e=>(0,t.jsxs)("div",{onClick:()=>ed(e),className:`flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors ${b?.id===e.id?"bg-yellow-50 border-r-2 border-yellow-500":"hover:bg-gray-50"}`,children:[(0,t.jsx)(q,{status:e.status,t:p}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-gray-700 truncate",children:e.exhibitNumber}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:e.fileName,children:e.fileName})]}),("pending"===e.status||"not_started"===e.status)&&!C&&d&&(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),el(e)},className:"px-1.5 py-0.5 text-xs text-yellow-600 hover:bg-yellow-100 rounded transition-colors",children:p.highlight.analyze})]},e.id))})})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,t.jsx)("div",{className:"px-4 py-2 border-b border-gray-100 bg-gray-50",children:(0,t.jsx)("span",{className:"text-xs font-medium text-gray-600",children:b?`${p.highlight.pdfPreview} - ${b.exhibitNumber}: ${b.fileName}`:p.highlight.pdfPreview})}),(0,t.jsx)("div",{className:"flex-1 overflow-hidden p-2",children:(0,t.jsx)(A,{documentId:b?.id||null,documentName:b?.fileName,pageCount:b?.pageCount||1,currentPage:E,onPageChange:B,selectedHighlightId:F})})]}),(0,t.jsxs)("div",{className:`border-l border-gray-200 flex flex-col transition-all duration-300 ${N?"w-10":"w-64"}`,children:[(0,t.jsxs)("div",{className:"px-3 py-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between",children:[(0,t.jsx)("button",{onClick:()=>k(!N),className:"p-1 hover:bg-gray-200 rounded transition-colors",title:N?p.common.expand:p.common.collapse,children:N?(0,t.jsx)(D,{}):(0,t.jsx)(H,{})}),!N&&(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-600",children:[p.highlight.highlightList," ",S.length>0&&`(${S.length})`]})]}),N?(0,t.jsx)("div",{className:"flex-1 flex flex-col items-center py-4",children:(0,t.jsx)("span",{className:"text-xs text-gray-500 [writing-mode:vertical-lr]",children:S.length>0?`${S.length} ${p.highlight.highlightAreas}`:p.highlight.noHighlights})}):(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:_?(0,t.jsx)("div",{className:"p-4 flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-5 h-5 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin"})}):0===S.length?(0,t.jsx)("div",{className:"p-4 text-center text-xs text-gray-400",children:b?.status==="completed"?p.highlight.noHighlights:p.highlight.showAfterAnalysis}):(0,t.jsx)("div",{className:"py-1",children:S.map((e,s)=>(0,t.jsxs)("div",{onClick:()=>{B(e.page_number),z(e.id)},className:`px-3 py-2 cursor-pointer transition-colors border-b border-gray-50 ${F===e.id?"bg-yellow-50 border-l-2 border-l-yellow-500":"hover:bg-gray-50"}`,children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,t.jsxs)("span",{className:"text-xs text-gray-400",children:["#",s+1]}),(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["P.",e.page_number]}),e.category_cn&&(0,t.jsx)("span",{className:"px-1.5 py-0.5 text-xs rounded bg-yellow-100 text-yellow-700",children:e.category_cn}),"high"===e.importance&&(0,t.jsx)("span",{className:"px-1.5 py-0.5 text-xs rounded bg-red-100 text-red-600",children:p.highlight.important})]}),(0,t.jsx)("p",{className:"text-xs text-gray-700 line-clamp-2",children:e.text_content||p.highlight.noTextContent})]},e.id||s))})})]})]})]})}let I={qualifying_relationship:{chinese:"合格的公司关系",english:"Qualifying Corporate Relationship",description:"美国公司与海外公司必须是母/子/分/关联公司关系",keywords:["母公司","子公司","关联公司","分公司","所有权","股权","持股","控股","共同控制"]},qualifying_employment:{chinese:"海外合格任职",english:"Qualifying Employment Abroad",description:"受益人过去3年中在海外关联公司连续工作至少1年",keywords:["任职","工作","职位","入职","离职","任期","年限","海外","境外"]},qualifying_capacity:{chinese:"合格的职位性质",english:"Qualifying Capacity",description:"L-1A: 高管/经理; L-1B: 专业知识人员",keywords:["高管","经理","管理","决策","战略","专业知识","专有技术","指导","监督","人事权","预算"]},doing_business:{chinese:"持续运营",english:"Doing Business",description:"美国和海外公司都必须持续、积极运营",keywords:["收入","利润","员工","雇员","银行","存款","合同","业务","办公","注册"]}},J=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),U=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),Q=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),K=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})}),G=({status:e,t:s})=>{let{bg:r,text:a,label:n}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:s.l1Analysis.status.idle},processing:{bg:"bg-indigo-100",text:"text-indigo-700",label:s.l1Analysis.status.processing},completed:{bg:"bg-green-100",text:"text-green-700",label:s.l1Analysis.status.completed},error:{bg:"bg-red-100",text:"text-red-700",label:s.l1Analysis.status.error}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${r} ${a}`,children:n})},Y=({quote:e,index:r,t:a})=>{let[n,l]=(0,s.useState)(!1);return(0,t.jsx)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-indigo-200 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsxs)("span",{className:"text-xs text-gray-400 mt-0.5",children:["#",r+1]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("p",{className:`text-sm text-gray-700 ${n?"":"line-clamp-2"}`,children:['"',e.quote,'"']}),e.quote.length>100&&(0,t.jsx)("button",{onClick:()=>l(!n),className:"text-xs text-indigo-600 hover:text-indigo-800 mt-1",children:n?a.common.collapse:a.common.expand}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-2 flex-wrap",children:[(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600",children:e.source?.exhibit_id||"N/A"}),e.page&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:["P.",e.page]})]}),e.relevance&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1 italic",children:[a.l1Analysis.relevance,": ",e.relevance]})]})]})})},X=({standardKey:e,quotes:r,defaultExpanded:a=!1,t:n})=>{let[l,i]=(0,s.useState)(a),o=I[e];return o?(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[(0,t.jsxs)("button",{onClick:()=>i(!l),className:"w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex items-center justify-between transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-indigo-100 text-indigo-700",children:r.length}),(0,t.jsxs)("div",{className:"text-left",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900",children:o.chinese}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:o.english})]})]}),l?(0,t.jsx)(K,{}):(0,t.jsx)(Q,{})]}),l&&(0,t.jsx)("div",{className:"p-4 space-y-3 bg-white",children:0===r.length?(0,t.jsx)("p",{className:"text-sm text-gray-400 text-center py-4",children:n.l1Analysis.noRelatedQuotes}):r.map((e,s)=>(0,t.jsx)(Y,{quote:e,index:s,t:n},s))})]}):null};function Z({projectId:e,onSuccess:n,onError:l}){let i,{t:o}=(0,m.useLanguage)(),[d,x]=(0,s.useState)("idle"),[u,h]=(0,s.useState)(null),[p,g]=(0,s.useState)(!1),[y,b]=(0,s.useState)(null),[f,j]=(0,s.useState)(!0),{isConnected:v,connect:N,disconnect:k}=w({url:e?(i=e,`${r}/api/l1-analyze/stream/${i}`):null,onMessage:(0,s.useCallback)(e=>{b(e),"processing"===e.status&&x("processing")},[]),onComplete:(0,s.useCallback)(async t=>{if(b(t),"completed"===t.status&&e)try{let s;await (s=e,a(`/api/l1-summary/${s}`,{method:"POST"}));let r=await c(e);h(r),x("completed"),n?.(`L-1 ${o.l1Analysis.status.completed}: ${t.completed} ${o.l1Analysis.documents}, ${o.l1Analysis.foundQuotes} ${t.total_quotes_found} ${o.l1Analysis.quotes}`)}catch(e){console.error("Failed to generate summary:",e),x("completed")}},[e,n]),onError:(0,s.useCallback)(()=>{console.warn("L1 SSE connection error")},[]),autoConnect:!1});(0,s.useEffect)(()=>(e?C():(h(null),x("idle"),b(null)),()=>{k()}),[e,k]);let C=async()=>{if(e)try{let t;g(!0);let s=await (t=e,a(`/api/l1-status/${t}`));if(s.has_summary&&s.summary_quotes>0){let t=await c(e);h(t),x("completed")}else h(null),x("idle")}catch(e){console.error("Failed to load existing analysis:",e),h(null),x("idle")}finally{g(!1)}},L=async()=>{if(e)try{var t;let s;if(x("processing"),b(null),(await (t=e,s="",a(`/api/l1-analyze/${t}${s}`,{method:"POST"}))).success)N();else throw Error("Failed to start analysis")}catch(t){console.error("L-1 analysis failed:",t);let e=t instanceof Error&&t.message.includes("fetch")?o.backend.cannotConnect:o.l1Analysis.analysisFailed;l?.(e),x("error")}},S=u?.total_quotes||0,$=e=>u?.by_standard&&u.by_standard[e]||[];return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50 cursor-pointer hover:bg-gray-100/50 transition-colors",onClick:()=>j(!f),children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600",children:(0,t.jsx)(J,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:o.l1Analysis.title}),S>0&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[S," ",o.l1Analysis.quotes]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:e=>{e.stopPropagation(),L()},disabled:!e||"processing"===d,className:"flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"processing"===d?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),o.l1Analysis.analyzing]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(U,{}),"completed"===d?o.l1Analysis.reanalyze:o.l1Analysis.startAnalysis]})}),(0,t.jsx)(G,{status:d,t:o}),(0,t.jsx)("div",{className:"ml-2 text-gray-400",children:f?(0,t.jsx)(K,{}):(0,t.jsx)(Q,{})})]})]})}),f&&(0,t.jsx)("div",{className:"p-4",children:e?p?(0,t.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-500",children:o.common.loading})]}):"processing"===d?(0,t.jsxs)("div",{className:"py-6",children:[(0,t.jsxs)("div",{className:"mb-4",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm mb-2",children:[(0,t.jsxs)("span",{className:"text-gray-600",children:[o.l1Analysis.progress,": ",y?.completed||0,"/",y?.total||0," ",o.l1Analysis.documents]}),(0,t.jsxs)("span",{className:"text-indigo-600 font-medium",children:[y?.progress_percent||0,"%"]})]}),(0,t.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,t.jsx)("div",{className:"bg-indigo-600 h-2 rounded-full transition-all duration-300",style:{width:`${y?.progress_percent||0}%`}})})]}),y?.current_doc&&(0,t.jsx)("div",{className:"bg-indigo-50 rounded-lg p-3 mb-3",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"}),(0,t.jsxs)("span",{className:"text-sm text-indigo-700",children:[o.l1Analysis.currentlyAnalyzing,": ",y.current_doc.exhibit_id," - ",y.current_doc.file_name]})]})}),y&&y.total_quotes_found>0&&(0,t.jsxs)("div",{className:"text-center text-sm text-gray-500",children:[o.l1Analysis.foundQuotes," ",y.total_quotes_found," ",o.l1Analysis.quotes]}),y?.errors&&y.errors.length>0&&(0,t.jsxs)("div",{className:"mt-3 text-sm text-red-600",children:[y.errors.length," ",o.l1Analysis.docsFailed]})]}):"idle"===d?(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:o.l1Analysis.clickToStart}),(0,t.jsx)("p",{className:"mt-1 text-xs",children:o.l1Analysis.autoExtract})]}):"error"===d?(0,t.jsxs)("div",{className:"text-center py-8 text-red-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:o.l1Analysis.retryMessage})]}):u&&S>0?(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("div",{className:"grid grid-cols-4 gap-3 mb-4",children:Object.keys(I).map(e=>{let s=$(e).length,r=I[e];return(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-indigo-600",children:s}),(0,t.jsx)("p",{className:"text-xs text-gray-500 truncate",title:r.chinese,children:r.chinese})]},e)})}),(0,t.jsx)("div",{className:"space-y-3",children:Object.keys(I).map(e=>(0,t.jsx)(X,{standardKey:e,quotes:$(e),defaultExpanded:!1,t:o},e))})]}):(0,t.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,t.jsx)("p",{className:"text-sm",children:o.l1Analysis.noQuotes})}):(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)(J,{}),(0,t.jsx)("p",{className:"mt-2 text-sm",children:o.l1Analysis.selectProject})]})})]})}var ee=e.i(70703);let et=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"})}),es=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),er=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),ea=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),en=({confidence:e})=>{let s=Math.round(100*e),r=s>=90?"bg-green-100 text-green-700":s>=70?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700";return(0,t.jsxs)("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${r}`,children:[s,"%"]})},el=({suggestion:e,isSelected:s,onToggle:r,t:a})=>{let n="merge_entities"===e.type;return(0,t.jsx)("div",{className:`border rounded-lg p-4 transition-colors cursor-pointer ${s?"border-rose-400 bg-rose-50/50":"border-gray-200 hover:border-gray-300"}`,onClick:r,children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:`flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${s?"bg-rose-500 border-rose-500 text-white":"border-gray-300"}`,children:s&&(0,t.jsx)(er,{})}),(0,t.jsx)("div",{className:`flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center ${n?"bg-blue-100 text-blue-600":"bg-yellow-100 text-yellow-600"}`,children:n?(0,t.jsx)(et,{}):(0,t.jsx)(es,{})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${n?"bg-blue-100 text-blue-700":"bg-yellow-100 text-yellow-700"}`,children:n?a.relationship.dedup?.merge||"Merge":a.relationship.dedup?.suspicious||"Suspicious"}),(0,t.jsx)(en,{confidence:e.confidence})]}),n?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("p",{className:"text-sm font-medium text-gray-900 mb-1",children:[e.primary_name,(0,t.jsx)("span",{className:"text-gray-400 mx-2",children:"←"}),e.duplicate_names?.join(", ")]}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:e.reason})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900 mb-1",children:e.entity_name}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:[e.reason,e.action&&(0,t.jsxs)("span",{className:"ml-2 text-yellow-600",children:["(",a.relationship.dedup?.reviewOrDelete||"Review or delete",")"]})]})]})]})]})})};function ei({isOpen:e,onClose:r,suggestions:a,onApply:n,isApplying:l}){let{t:i}=(0,m.useLanguage)(),[o,d]=(0,s.useState)(new Set(a.map(e=>e.id)));if(!e)return null;let c=async()=>{let e=[];for(let t of a)o.has(t.id)&&("merge_entities"===t.type&&t.primary_id&&t.duplicate_ids?e.push({type:"merge",primary_id:t.primary_id,merge_ids:t.duplicate_ids}):"suspicious_entity"===t.type&&t.entity_id&&e.push({type:"delete",entity_id:t.entity_id}));e.length>0&&await n(e)},x=o.size,u=a.filter(e=>"merge_entities"===e.type&&o.has(e.id)).length,h=a.filter(e=>"suspicious_entity"===e.type&&o.has(e.id)).length;return(0,t.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,t.jsx)("div",{className:"absolute inset-0 bg-black/50",onClick:r}),(0,t.jsxs)("div",{className:"relative bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col",children:[(0,t.jsxs)("div",{className:"px-6 py-4 border-b border-gray-100 flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:i.relationship.dedup?.title||"Deduplication Suggestions"}),(0,t.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:i.relationship.dedup?.foundSuggestions?.replace("{count}",String(a.length))||`Found ${a.length} suggestions`})]}),(0,t.jsx)("button",{onClick:r,className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors",children:(0,t.jsx)(ea,{})})]}),(0,t.jsxs)("div",{className:"px-6 py-3 border-b border-gray-100 flex items-center gap-4 bg-gray-50/50",children:[(0,t.jsx)("span",{className:"text-sm text-gray-600",children:i.relationship.dedup?.selected?.replace("{count}",String(x))||`${x} selected`}),(0,t.jsx)("button",{onClick:()=>{d(new Set(a.map(e=>e.id)))},className:"text-sm text-rose-600 hover:text-rose-700",children:i.common.selectAll||"Select all"}),(0,t.jsx)("button",{onClick:()=>{d(new Set)},className:"text-sm text-gray-500 hover:text-gray-700",children:i.common.selectNone||"Select none"})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-6",children:0===a.length?(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)(er,{}),(0,t.jsx)("p",{className:"mt-2",children:i.relationship.dedup?.noSuggestions||"No duplicates found"})]}):(0,t.jsx)("div",{className:"space-y-3",children:a.map(e=>(0,t.jsx)(el,{suggestion:e,isSelected:o.has(e.id),onToggle:()=>{var t;let s;return t=e.id,void((s=new Set(o)).has(t)?s.delete(t):s.add(t),d(s))},t:i},e.id))})}),(0,t.jsxs)("div",{className:"px-6 py-4 border-t border-gray-100 flex items-center justify-between bg-gray-50/50",children:[(0,t.jsxs)("div",{className:"text-sm text-gray-500",children:[u>0&&(0,t.jsx)("span",{className:"mr-3",children:i.relationship.dedup?.willMerge?.replace("{count}",String(u))||`Will merge ${u} entities`}),h>0&&(0,t.jsx)("span",{className:"text-yellow-600",children:i.relationship.dedup?.willDelete?.replace("{count}",String(h))||`Will delete ${h} entities`})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("button",{onClick:r,disabled:l,className:"px-4 py-2 text-sm text-gray-600 hover:text-gray-800 disabled:opacity-50",children:i.common.cancel}),(0,t.jsx)("button",{onClick:c,disabled:l||0===x,className:"px-4 py-2 text-sm font-medium text-white bg-rose-600 hover:bg-rose-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:l?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),i.relationship.dedup?.applying||"Applying..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(er,{}),i.relationship.dedup?.applySelected||"Apply Selected"]})})]})]})]})]})}let eo=(0,ee.default)(()=>e.A(43197),{loadableGenerated:{modules:[66673]},ssr:!1,loading:()=>(0,t.jsx)("div",{className:"h-[400px] flex items-center justify-center",children:(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-rose-500 border-t-transparent rounded-full animate-spin"})})}),ed=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),ec=()=>(0,t.jsxs)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),ex=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),eu=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})}),eh=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 10h16M4 14h16M4 18h16"})}),em=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})}),ep=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"})}),eg=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),ey=(e,t)=>({person:t.relationship.entityTypes.person,organization:t.relationship.entityTypes.organization,company:t.relationship.entityTypes.company,date:t.relationship.entityTypes.date,location:t.relationship.entityTypes.location,position:t.relationship.entityTypes.position,event:t.relationship.entityTypes.event,document:t.relationship.entityTypes.document})[e]||e,eb=({status:e,t:s})=>{let{bg:r,text:a,label:n}={idle:{bg:"bg-gray-100",text:"text-gray-600",label:s.relationship.status.idle},processing:{bg:"bg-rose-100",text:"text-rose-700",label:s.relationship.status.processing},completed:{bg:"bg-green-100",text:"text-green-700",label:s.relationship.status.completed},error:{bg:"bg-red-100",text:"text-red-700",label:s.relationship.status.error}}[e];return(0,t.jsx)("span",{className:`px-2.5 py-1 text-xs font-medium rounded-full ${r} ${a}`,children:n})},ef=({entity:e,t:s})=>{let r=ey(e.type,s),a={person:"bg-blue-100 text-blue-700",organization:"bg-purple-100 text-purple-700",company:"bg-green-100 text-green-700",date:"bg-yellow-100 text-yellow-700",location:"bg-orange-100 text-orange-700",position:"bg-pink-100 text-pink-700",event:"bg-cyan-100 text-cyan-700",document:"bg-gray-100 text-gray-700"}[e.type]||"bg-gray-100 text-gray-700";return(0,t.jsx)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-rose-200 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded ${a}`,children:r}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.name}),e.documents.length>0&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[s.relationship.source,": ",e.documents.slice(0,3).join(", "),e.documents.length>3&&` +${e.documents.length-3}`]})]})]})})},ej=({relation:e,entities:s,t:r})=>{var a;let n=s.find(t=>t.id===e.source_id),l=s.find(t=>t.id===e.target_id),i=(a=e.relation_type,({works_for:r.relationship.relationTypes.works_for,owns:r.relationship.relationTypes.owns,subsidiary_of:r.relationship.relationTypes.subsidiary_of,affiliated_with:r.relationship.relationTypes.affiliated_with,employed_by:r.relationship.relationTypes.employed_by,manages:r.relationship.relationTypes.manages,reports_to:r.relationship.relationTypes.reports_to,founded:r.relationship.relationTypes.founded,located_in:r.relationship.relationTypes.located_in})[a]||a);return(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-rose-200 transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-rose-50 text-rose-700 border border-rose-200",children:n?.name||e.source_id}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:(0,t.jsx)("svg",{className:"w-4 h-4 inline",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})}),(0,t.jsx)("span",{className:"px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-700",children:i}),(0,t.jsx)("span",{className:"text-xs text-gray-500",children:(0,t.jsx)("svg",{className:"w-4 h-4 inline",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14 5l7 7m0 0l-7 7m7-7H3"})})}),(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-rose-50 text-rose-700 border border-rose-200",children:l?.name||e.target_id})]}),e.description&&(0,t.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:e.description})]})},ev=({chain:e,t:r})=>{var a;let[n,l]=(0,s.useState)(!1);return(0,t.jsx)("div",{className:"border border-gray-200 rounded-lg p-3 hover:border-rose-200 transition-colors",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsx)("span",{className:`px-2 py-0.5 text-xs font-medium rounded flex-shrink-0 ${{strong:"bg-green-100 text-green-700",medium:"bg-yellow-100 text-yellow-700",weak:"bg-red-100 text-red-700"}[e.strength]||"bg-gray-100 text-gray-700"}`,children:(a=e.strength,({strong:r.relationship.strength.strong,medium:r.relationship.strength.medium,weak:r.relationship.strength.weak})[a]||a)}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:`text-sm text-gray-700 ${n?"":"line-clamp-2"}`,children:e.claim}),e.claim.length>100&&(0,t.jsx)("button",{onClick:()=>l(!n),className:"text-xs text-rose-600 hover:text-rose-800 mt-1",children:n?r.common.collapse:r.common.expand}),e.documents.length>0&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-2",children:[r.relationship.evidenceSource,": ",e.documents.join(", ")]}),e.reasoning&&n&&(0,t.jsxs)("p",{className:"text-xs text-gray-500 mt-1 italic",children:[r.relationship.reasoning,": ",e.reasoning]})]})]})})},eN=({title:e,count:r,children:a,defaultExpanded:n=!1})=>{let[l,i]=(0,s.useState)(n);return(0,t.jsxs)("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[(0,t.jsxs)("button",{onClick:()=>i(!l),className:"w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 flex items-center justify-between transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("span",{className:"px-2 py-1 text-xs font-medium rounded bg-rose-100 text-rose-700",children:r}),(0,t.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e})]}),l?(0,t.jsx)(eu,{}):(0,t.jsx)(ex,{})]}),l&&(0,t.jsx)("div",{className:"p-4 space-y-3 bg-white",children:a})]})};function ew({projectId:e,onSuccess:n,onError:l}){let i,{t:o}=(0,m.useLanguage)(),[d,c]=(0,s.useState)("idle"),[x,u]=(0,s.useState)(null),[h,p]=(0,s.useState)(!1),[g,y]=(0,s.useState)("graph"),[b,f]=(0,s.useState)(!1),[j,v]=(0,s.useState)([]),[N,k]=(0,s.useState)(!1),[C,L]=(0,s.useState)(!1),[S,$]=(0,s.useState)([]),[_,M]=(0,s.useState)(null),[E,B]=(0,s.useState)(!1),{connect:F,disconnect:z}=w({url:e?(i=e,`${r}/api/relationship/stream/${i}`):null,onMessage:(0,s.useCallback)(e=>{"processing"===e.status&&c("processing")},[]),onComplete:(0,s.useCallback)(e=>{"completed"===e.status&&e.result?(u(e.result),c("completed"),n?.(`${o.relationship.status.completed}: ${e.result.entities?.length||0} ${o.relationship.entities}, ${e.result.relations?.length||0} ${o.relationship.relations}`)):"failed"===e.status&&(c("error"),l?.(e.error||o.relationship.analysisFailed))},[n,l,o]),onError:(0,s.useCallback)(()=>{console.warn("Relationship SSE connection error")},[]),autoConnect:!1});(0,s.useEffect)(()=>(e?(W(),P()):(u(null),c("idle"),$([])),()=>{z()}),[e,z]);let W=async()=>{if(e)try{let t;p(!0);let s=await (t=e,a(`/api/projects/${t}/relationship`));s.data&&(s.data.entities.length>0||s.data.relations.length>0)?(u(s.data),c("completed")):(u(null),c("idle"))}catch(e){console.error("Failed to load existing relationship analysis:",e),u(null),c("idle")}finally{p(!1)}},P=async()=>{if(e)try{let t,s=await (t=e,a(`/api/relationship/snapshots/${t}`));$(s.snapshots||[]),M(s.current_snap)}catch(e){console.error("Failed to load snapshots:",e)}},A=async()=>{if(e)try{let t;k(!0);let s=await (t=e,a(`/api/relationship/deduplicate/${t}`,{method:"POST"}));v(s.suggestions||[]),f(!0)}catch(e){console.error("Deduplication analysis failed:",e),l?.(o.relationship.dedup?.analysisFailed||"Deduplication analysis failed")}finally{k(!1)}},T=async t=>{if(e)try{let s,r;L(!0);let l=await (s=e,r=t,a(`/api/relationship/apply-dedup/${s}`,{method:"POST",body:JSON.stringify({actions:r})}));f(!1),n?.(o.relationship.dedup?.applied?.replace("{merged}",String(l.merged_count))?.replace("{deleted}",String(l.deleted_count))||`Applied: ${l.merged_count} merged, ${l.deleted_count} deleted`),await W(),await P()}catch(e){console.error("Failed to apply deduplication:",e),l?.(o.relationship.dedup?.applyFailed||"Failed to apply deduplication")}finally{L(!1)}},O=async t=>{if(e)try{let s,r,l=await (s=e,r=t,a(`/api/relationship/rollback/${s}`,{method:"POST",body:JSON.stringify({snapshot_id:r})}));n?.(o.relationship.snapshot?.rolledBack?.replace("{label}",l.label)||`Rolled back to: ${l.label}`),B(!1),await W(),await P()}catch(e){console.error("Rollback failed:",e),l?.(o.relationship.snapshot?.rollbackFailed||"Rollback failed")}},R=async t=>{if(e)try{let s,r;await (s=e,r=t,a(`/api/relationship/entity/${s}/${r}`,{method:"DELETE"})),n?.(o.relationship.edit?.entityDeleted||"Entity deleted"),await W()}catch(e){console.error("Delete entity failed:",e),l?.(o.relationship.edit?.deleteFailed||"Delete failed")}},D=async(t,s)=>{if(e)try{let r,l,i;await (r=e,l=t,i={name:s},a(`/api/relationship/entity/${r}/${l}`,{method:"PATCH",body:JSON.stringify(i)})),n?.(o.relationship.edit?.entityRenamed||"Entity renamed"),await W()}catch(e){console.error("Rename entity failed:",e),l?.(o.relationship.edit?.renameFailed||"Rename failed")}},H=async(t,s,r)=>{if(e)try{let l,i,d,c;await (l=e,i=t,d=s,c=r,a(`/api/relationship/relation/${l}`,{method:"DELETE",body:JSON.stringify({from_entity:i,to_entity:d,relation_type:c})})),n?.(o.relationship.edit?.relationDeleted||"Relation deleted"),await W()}catch(e){console.error("Delete relation failed:",e),l?.(o.relationship.edit?.deleteFailed||"Delete failed")}},q=async()=>{if(e)try{var t;let s;if(c("processing"),(await (t=e,s="",a(`/api/relationship/${t}${s}`,{method:"POST"}))).success)F();else throw Error("Failed to start analysis")}catch(t){console.error("Relationship analysis failed:",t);let e=t instanceof Error&&t.message.includes("fetch")?o.backend.cannotConnect:o.relationship.analysisFailed;l?.(e),c("error")}},V=x?.entities.length||0,I=x?.relations.length||0,J=x?.evidence_chains.length||0,U=x?.entities.reduce((e,t)=>{let s=t.type||"other";return e[s]||(e[s]=[]),e[s].push(t),e},{})||{};return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsx)("div",{className:"px-5 py-4 border-b border-gray-100 bg-gray-50/50",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-rose-100 rounded-lg flex items-center justify-center text-rose-600",children:(0,t.jsx)(ed,{})}),(0,t.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:o.relationship.title}),(V>0||I>0)&&(0,t.jsxs)("span",{className:"text-xs text-gray-500",children:[V," ",o.relationship.entities," | ",I," ",o.relationship.relations]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["completed"===d&&(V>0||I>0)&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex items-center bg-gray-100 rounded-lg p-0.5",children:[(0,t.jsxs)("button",{onClick:()=>y("list"),className:`flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md transition-colors ${"list"===g?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,title:o.relationship.viewMode.list,children:[(0,t.jsx)(eh,{}),(0,t.jsx)("span",{className:"hidden sm:inline",children:o.relationship.viewMode.list})]}),(0,t.jsxs)("button",{onClick:()=>y("graph"),className:`flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-md transition-colors ${"graph"===g?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,title:o.relationship.viewMode.graph,children:[(0,t.jsx)(em,{}),(0,t.jsx)("span",{className:"hidden sm:inline",children:o.relationship.viewMode.graph})]})]}),(0,t.jsxs)("button",{onClick:A,disabled:N,className:"flex items-center gap-1.5 px-3 py-1.5 bg-purple-100 text-purple-700 text-xs font-medium rounded-lg hover:bg-purple-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:o.relationship.dedup?.title||"Deduplicate",children:[N?(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"}):(0,t.jsx)(ep,{}),(0,t.jsx)("span",{className:"hidden sm:inline",children:o.relationship.dedup?.button||"Deduplicate"})]}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsxs)("button",{onClick:()=>B(!E),className:"flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 text-gray-700 text-xs font-medium rounded-lg hover:bg-gray-200 transition-colors",title:o.relationship.snapshot?.history||"History",children:[(0,t.jsx)(eg,{}),(0,t.jsx)("span",{className:"hidden sm:inline",children:o.relationship.snapshot?.history||"History"}),S.length>0&&(0,t.jsx)("span",{className:"bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded text-xs",children:S.length})]}),E&&(0,t.jsxs)("div",{className:"absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-20",children:[(0,t.jsx)("div",{className:"px-3 py-2 border-b border-gray-100",children:(0,t.jsx)("p",{className:"text-xs font-medium text-gray-500",children:o.relationship.snapshot?.versions||"Versions"})}),(0,t.jsx)("div",{className:"max-h-64 overflow-y-auto",children:0===S.length?(0,t.jsx)("p",{className:"px-3 py-4 text-sm text-gray-400 text-center",children:o.relationship.snapshot?.noSnapshots||"No snapshots"}):S.map(e=>(0,t.jsxs)("button",{onClick:()=>O(e.id),disabled:e.id===_,className:`w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center justify-between ${e.id===_?"bg-rose-50":""}`,children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-medium text-gray-800",children:e.label}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleString()}),(0,t.jsxs)("p",{className:"text-xs text-gray-400",children:[e.stats.entity_count," ",o.relationship.entities,", ",e.stats.relation_count," ",o.relationship.relations]})]}),e.id===_&&(0,t.jsx)("span",{className:"text-xs bg-rose-100 text-rose-700 px-2 py-0.5 rounded",children:o.relationship.snapshot?.current||"Current"}),e.is_original&&(0,t.jsx)("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded",children:o.relationship.snapshot?.original||"Original"})]},e.id))})]})]})]}),(0,t.jsx)("button",{onClick:q,disabled:!e||"processing"===d,className:"flex items-center gap-1.5 px-3 py-1.5 bg-rose-600 text-white text-xs font-medium rounded-lg hover:bg-rose-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"processing"===d?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),o.relationship.analyzing]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(ec,{}),"completed"===d?o.relationship.reanalyze:o.relationship.startAnalysis]})}),(0,t.jsx)(eb,{status:d,t:o})]})]})}),(0,t.jsx)("div",{className:"p-4",children:e?h?(0,t.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,t.jsx)("div",{className:"w-6 h-6 border-2 border-rose-500 border-t-transparent rounded-full animate-spin"}),(0,t.jsx)("span",{className:"ml-2 text-sm text-gray-500",children:o.common.loading})]}):"idle"===d?(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:o.relationship.clickToStart}),(0,t.jsx)("p",{className:"mt-1 text-xs",children:o.relationship.analyzeEntities})]}):"error"===d?(0,t.jsxs)("div",{className:"text-center py-8 text-red-400",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),(0,t.jsx)("p",{className:"mt-3 text-sm",children:o.relationship.retryMessage})]}):x&&(V>0||I>0)?(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-3 mb-4",children:[(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-rose-600",children:V}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:o.relationship.entities})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-rose-600",children:I}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:o.relationship.relations})]}),(0,t.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 text-center",children:[(0,t.jsx)("p",{className:"text-2xl font-bold text-rose-600",children:J}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:o.relationship.evidenceChains})]})]}),"graph"===g?(0,t.jsx)(eo,{entities:x.entities,relations:x.relations,onDeleteEntity:R,onRenameEntity:D,onDeleteRelation:H}):(0,t.jsxs)(t.Fragment,{children:[V>0&&(0,t.jsx)(eN,{title:o.relationship.entityList,count:V,defaultExpanded:!0,children:Object.entries(U).map(([e,s])=>(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("p",{className:"text-xs font-medium text-gray-500 uppercase",children:[ey(e,o)," (",s.length,")"]}),(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:s.map(e=>(0,t.jsx)(ef,{entity:e,t:o},e.id))})]},e))}),I>0&&(0,t.jsx)(eN,{title:o.relationship.relationList,count:I,children:(0,t.jsx)("div",{className:"space-y-2",children:x.relations.map((e,s)=>(0,t.jsx)(ej,{relation:e,entities:x.entities,t:o},s))})}),J>0&&(0,t.jsx)(eN,{title:o.relationship.evidenceChains,count:J,children:(0,t.jsx)("div",{className:"space-y-2",children:x.evidence_chains.map((e,s)=>(0,t.jsx)(ev,{chain:e,t:o},s))})})]})]}):(0,t.jsx)("div",{className:"text-center py-8 text-gray-400",children:(0,t.jsx)("p",{className:"text-sm",children:o.relationship.noEntitiesOrRelations})}):(0,t.jsxs)("div",{className:"text-center py-8 text-gray-400",children:[(0,t.jsx)(ed,{}),(0,t.jsx)("p",{className:"mt-2 text-sm",children:o.relationship.selectProject})]})}),(0,t.jsx)(ei,{isOpen:b,onClose:()=>f(!1),suggestions:j,onApply:T,isApplying:C}),E&&(0,t.jsx)("div",{className:"fixed inset-0 z-10",onClick:()=>B(!1)})]})}let ek=["qualifying_relationship","qualifying_employment","qualifying_capacity","doing_business"],eC={qualifying_relationship:"Qual. Relationship",qualifying_employment:"Qual. Employment",qualifying_capacity:"Qual. Capacity",doing_business:"Doing Business"},eL=({status:e})=>(0,t.jsx)("span",{className:`w-2 h-2 rounded-full ${{empty:"bg-gray-300",draft:"bg-yellow-400",complete:"bg-green-500"}[e]}`});function eS({activeSection:e,onSectionChange:s,sectionStatus:r={qualifying_relationship:"empty",qualifying_employment:"empty",qualifying_capacity:"empty",doing_business:"empty"}}){return(0,t.jsx)("div",{className:"flex border-b border-gray-200 bg-white",children:ek.map(a=>{let n=e===a,l=r[a],i=I[a];return(0,t.jsxs)("button",{onClick:()=>s(a),className:`
              flex items-center gap-2 px-4 py-3 text-sm font-medium transition-colors
              border-b-2 -mb-[2px]
              ${n?"border-blue-600 text-blue-600 bg-blue-50":"border-transparent text-gray-600 hover:text-gray-900 hover:bg-gray-50"}
            `,title:i.english,children:[(0,t.jsx)(eL,{status:l}),(0,t.jsx)("span",{className:"hidden sm:inline",children:eC[a]}),(0,t.jsx)("span",{className:"sm:hidden",children:a.split("_")[1].slice(0,3)})]},a)})})}function e$({citation:e,position:r,onClose:n}){let[l,i]=(0,s.useState)(null),[o,d]=(0,s.useState)(!0),[c,x]=(0,s.useState)(null);(0,s.useEffect)(()=>{let t=!0;return(async()=>{try{var s,r,n;let l;d(!0),x(null);let o=await (s=e.document_id,r=e.page_number,l=(n=e.bbox)?`?bbox=${encodeURIComponent(JSON.stringify(n))}`:"",a(`/api/pdf-preview/${s}/${r}${l}`));t&&i(o.image)}catch(e){t&&(x("Failed to load preview"),console.error("Preview load error:",e))}finally{t&&d(!1)}})(),()=>{t=!1}},[e.document_id,e.page_number,e.bbox]),(0,s.useEffect)(()=>{let e=e=>{e.target.closest(".citation-tooltip")||n()};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[n]);let u={x:Math.min(r.x,window.innerWidth-280),y:r.y+20};return(0,t.jsxs)("div",{className:"citation-tooltip fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-3 w-64 animate-fade-in",style:{left:u.x,top:u.y},children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("span",{className:"text-xs font-medium text-gray-700",children:["Exhibit ",e.exhibit]}),(0,t.jsx)("button",{onClick:n,className:"text-gray-400 hover:text-gray-600",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsxs)("div",{className:"text-xs text-gray-500 mb-2",children:[e.file_name," - Page ",e.page_number]}),(0,t.jsx)("div",{className:"relative bg-gray-100 rounded border border-gray-200 overflow-hidden",children:o?(0,t.jsx)("div",{className:"h-32 flex items-center justify-center",children:(0,t.jsxs)("svg",{className:"w-6 h-6 text-gray-400 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):c?(0,t.jsx)("div",{className:"h-32 flex items-center justify-center text-gray-400 text-xs",children:c}):l?(0,t.jsx)("img",{src:l,alt:`Page ${e.page_number} preview`,className:"w-full h-auto"}):null}),e.quote&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-600 line-clamp-3 italic border-l-2 border-blue-300 pl-2",children:["“",e.quote,"”"]}),e.claim&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-500",children:[(0,t.jsx)("span",{className:"font-medium",children:"Supports:"})," ",e.claim]})]})}function e_({selection:e,position:s,onEdit:r,onCopy:a,onClose:n}){let l={x:Math.max(10,Math.min(s.x-50,window.innerWidth-130)),y:s.y-45};return(0,t.jsxs)("div",{className:"fixed z-50 animate-fade-in",style:{left:l.x,top:l.y},children:[(0,t.jsxs)("div",{className:"bg-gray-900 text-white px-2 py-1.5 rounded-lg shadow-lg flex items-center gap-1",children:[(0,t.jsxs)("button",{onClick:r,className:"flex items-center gap-1.5 px-2 py-1 rounded hover:bg-gray-700 transition-colors text-sm",title:"Edit selection",children:[(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,t.jsx)("span",{children:"Edit"})]}),a&&(0,t.jsx)("div",{className:"w-px h-4 bg-gray-600"}),a&&(0,t.jsx)("button",{onClick:a,className:"flex items-center gap-1.5 px-2 py-1 rounded hover:bg-gray-700 transition-colors text-sm",title:"Copy selection",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})})}),(0,t.jsx)("button",{onClick:n,className:"flex items-center px-1.5 py-1 rounded hover:bg-gray-700 transition-colors",title:"Close",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsx)("div",{className:"absolute left-1/2 transform -translate-x-1/2 -bottom-1.5",children:(0,t.jsx)("div",{className:"w-3 h-3 bg-gray-900 rotate-45"})})]})}let eM=/\[Exhibit\s+([A-Z]-?\d+)(?::\s*([^\]]+))?\]/g;function eE({content:e,onChange:r,citations:a,onSelectionChange:n,selectionEditMode:l,onEditSelection:i,readOnly:o=!1}){let d=(0,s.useRef)(null),[c,x]=(0,s.useState)(null),[u,h]=(0,s.useState)(null),m=(0,s.useCallback)(e=>a.find(t=>t.exhibit===e),[a]),p=(0,s.useCallback)((e,t)=>{let s=m(e);if(s){let e=t.target.getBoundingClientRect();x({citation:s,position:{x:e.left,y:e.bottom}})}},[m]),g=(0,s.useCallback)(()=>{setTimeout(()=>{x(null)},100)},[]),y=(0,s.useCallback)(()=>{let t=window.getSelection();if(!t||t.isCollapsed||!d.current){h(null),n(null);return}let s=t.toString().trim();if(!s){h(null),n(null);return}let r=t.getRangeAt(0).getBoundingClientRect(),a=e.indexOf(s),l=a+s.length,i={text:s,start:a>=0?a:0,end:a>=0?l:s.length,position:{x:r.left+r.width/2,y:r.top}};h(i),n({text:i.text,start:i.start,end:i.end})},[e,n]);(0,s.useEffect)(()=>(document.addEventListener("selectionchange",y),()=>document.removeEventListener("selectionchange",y)),[y]);let b=(0,s.useCallback)(e=>{let t=e.target;if(t.closest(".citation-link")||t.closest(".selection-bubble"))return},[]),f=(0,s.useCallback)(e=>{r(e.target.innerText)},[r]);return(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{ref:d,contentEditable:!o,suppressContentEditableWarning:!0,onInput:f,onClick:b,className:`min-h-[300px] p-4 text-gray-800 leading-relaxed focus:outline-none ${o?"bg-gray-50":"bg-white"}`,style:{whiteSpace:"pre-wrap"},children:(function(e){let t=[],s=0;for(let r of e.matchAll(eM))r.index>s&&t.push({type:"text",content:e.slice(s,r.index)}),t.push({type:"citation",content:r[0],exhibit:r[1],title:r[2]}),s=r.index+r[0].length;return s<e.length&&t.push({type:"text",content:e.slice(s)}),t})(e).map((e,s)=>{if("citation"===e.type){let r=m(e.exhibit);return(0,t.jsxs)("span",{className:`citation-link inline-flex items-center px-1 py-0.5 rounded text-sm font-medium cursor-pointer transition-colors ${r?"bg-blue-100 text-blue-700 hover:bg-blue-200":"bg-gray-100 text-gray-600"}`,onMouseEnter:t=>p(e.exhibit,t),onMouseLeave:g,children:[(0,t.jsx)("svg",{className:"w-3 h-3 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.content]},s)}return(0,t.jsx)("span",{children:e.content},s)})}),c&&(0,t.jsx)(e$,{citation:c.citation,position:c.position,onClose:()=>x(null)}),u&&"bubble"===l&&(0,t.jsx)(e_,{selection:{text:u.text,start:u.start,end:u.end},position:u.position,onEdit:i,onCopy:()=>navigator.clipboard.writeText(u.text),onClose:()=>{h(null),n(null),window.getSelection()?.removeAllRanges()}}),u&&"panel"===l&&(0,t.jsxs)("div",{className:"absolute top-2 right-2 bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full",children:[u.text.length," chars selected"]})]})}let eB=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})}),eF=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})});function ez({mode:e,selection:r,onSend:a,onShowHistory:n,isProcessing:l,recentMessages:i=[]}){let[o,d]=(0,s.useState)(""),c=(0,s.useRef)(null);(0,s.useEffect)(()=>{"right"===e&&r&&c.current&&c.current.focus()},[r,e]);let x=async e=>{e?.preventDefault(),o.trim()&&!l&&(await a(o.trim(),r),d(""))},u=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),x())};return"bottom"===e?(0,t.jsxs)("div",{className:"border-t border-gray-200 bg-white p-4",children:[r&&(0,t.jsxs)("div",{className:"mb-3 flex items-start gap-2 p-2 bg-yellow-50 rounded-lg border border-yellow-200",children:[(0,t.jsx)("span",{className:"text-xs text-yellow-700 font-medium whitespace-nowrap",children:"Selected:"}),(0,t.jsxs)("span",{className:"text-xs text-yellow-800 line-clamp-2",children:["“",r.text,"”"]})]}),(0,t.jsxs)("form",{onSubmit:x,className:"flex items-end gap-3",children:[(0,t.jsx)("div",{className:"flex-1 relative",children:(0,t.jsx)("textarea",{ref:c,value:o,onChange:e=>d(e.target.value),onKeyDown:u,placeholder:r?"How should I modify this selection?":"Enter editing instructions...",className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",rows:1,disabled:l})}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{type:"button",onClick:n,className:"p-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-xl transition-colors",title:"View history",children:(0,t.jsx)(eF,{})}),(0,t.jsx)("button",{type:"submit",disabled:!o.trim()||l,className:"p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:l?(0,t.jsxs)("svg",{className:"w-5 h-5 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):(0,t.jsx)(eB,{})})]})]})]}):(0,t.jsxs)("div",{className:"w-80 border-l border-gray-200 bg-white flex flex-col h-full",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-medium text-gray-900",children:"Edit Assistant"}),(0,t.jsx)("button",{onClick:n,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors",title:"View history",children:(0,t.jsx)(eF,{})})]}),r&&(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 bg-yellow-50",children:[(0,t.jsx)("div",{className:"text-xs text-gray-500 mb-1",children:"Selected text:"}),(0,t.jsxs)("div",{className:"text-sm text-gray-800 line-clamp-4 bg-white p-2 rounded border border-yellow-200",children:["“",r.text,"”"]})]}),i.length>0&&(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:i.slice(-3).map(e=>(0,t.jsx)("div",{className:`text-sm p-2 rounded-lg ${"user"===e.role?"bg-blue-50 text-blue-900 ml-4":"bg-gray-50 text-gray-700 mr-4"}`,children:e.content},e.id))}),(0,t.jsxs)("div",{className:"p-4 border-t border-gray-200 mt-auto",children:[(0,t.jsx)("textarea",{ref:c,value:o,onChange:e=>d(e.target.value),onKeyDown:u,placeholder:r?"How should I modify this?":"Enter editing instructions...",className:"w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",rows:3,disabled:l}),(0,t.jsx)("button",{onClick:()=>x(),disabled:!o.trim()||l,className:"mt-3 w-full py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2",children:l?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),(0,t.jsx)("span",{children:"Processing..."})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("span",{children:"Apply Changes"}),(0,t.jsx)(eB,{})]})})]})]})}function eW({isOpen:e,onClose:r,history:a,onApplyMessage:n}){let[l,i]=(0,s.useState)(""),o=(0,s.useRef)(null);(0,s.useEffect)(()=>{let t=e=>{"Escape"===e.key&&r()};if(e)return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[e,r]);let d=a.filter(e=>e.content.toLowerCase().includes(l.toLowerCase())).reduce((e,t)=>{let s,r,a,n=(s=new Date(t.timestamp),((a=new Date(r=new Date)).setDate(a.getDate()-1),s.toDateString()===r.toDateString())?"Today":s.toDateString()===a.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"}));return e[n]||(e[n]=[]),e[n].push(t),e},{});return e?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"fixed inset-0 bg-black/30 z-40 transition-opacity",onClick:r}),(0,t.jsxs)("div",{ref:o,className:"fixed right-0 top-0 h-full w-96 max-w-full bg-white shadow-xl z-50 flex flex-col animate-slide-in-right",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[(0,t.jsx)("h2",{className:"font-semibold text-gray-900",children:"Edit History"}),(0,t.jsx)("button",{onClick:r,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsx)("div",{className:"p-4 border-b border-gray-200",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("svg",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),(0,t.jsx)("input",{type:"text",value:l,onChange:e=>i(e.target.value),placeholder:"Search history...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===Object.keys(d).length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[(0,t.jsx)("svg",{className:"w-12 h-12 mb-3 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,t.jsx)("p",{className:"text-sm",children:l?"No matching messages":"No history yet"})]}):(0,t.jsx)("div",{className:"divide-y divide-gray-100",children:Object.entries(d).map(([e,s])=>(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"px-4 py-2 bg-gray-50 sticky top-0",children:(0,t.jsx)("span",{className:"text-xs font-medium text-gray-500",children:e})}),(0,t.jsx)("div",{className:"divide-y divide-gray-50",children:s.map(e=>(0,t.jsxs)("div",{className:"p-4 hover:bg-gray-50 transition-colors",children:[(0,t.jsxs)("div",{className:"flex items-start justify-between gap-2 mb-1",children:[(0,t.jsx)("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${"user"===e.role?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:"user"===e.role?"You":"Assistant"}),(0,t.jsx)("span",{className:"text-xs text-gray-400",children:new Date(e.timestamp).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})})]}),(0,t.jsx)("p",{className:"text-sm text-gray-700 line-clamp-3",children:e.content}),e.selection&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-500 bg-gray-100 p-2 rounded",children:[(0,t.jsx)("span",{className:"font-medium",children:"Selection:"})," ","“",e.selection.text.slice(0,50),e.selection.text.length>50?"...":"","”"]}),n&&"assistant"===e.role&&(0,t.jsx)("button",{onClick:()=>n(e),className:"mt-2 text-xs text-blue-600 hover:text-blue-800",children:"Apply this change"})]},e.id))})]},e))})}),(0,t.jsx)("div",{className:"p-4 border-t border-gray-200 bg-gray-50",children:(0,t.jsxs)("p",{className:"text-xs text-gray-500 text-center",children:[a.length," message",1!==a.length?"s":""," in history"]})})]})]}):null}let eP=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),eA=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),eT=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})}),eO=()=>(0,t.jsxs)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]});function eR({projectId:e,onSuccess:r,onError:n,modelsReady:l=!0}){let{t:i}=(0,m.useLanguage)(),[o,d]=(0,s.useState)("qualifying_relationship"),[c,x]=(0,s.useState)({qualifying_relationship:{content:"",citations:[],status:"empty"},qualifying_employment:{content:"",citations:[],status:"empty"},qualifying_capacity:{content:"",citations:[],status:"empty"},doing_business:{content:"",citations:[],status:"empty"}}),[u,h]=(0,s.useState)([]),[p,g]=(0,s.useState)(!1),[y,b]=(0,s.useState)(null),[f,j]=(0,s.useState)("bottom"),[v,N]=(0,s.useState)("bubble"),[w,k]=(0,s.useState)(!1),[C,L]=(0,s.useState)(!1),[S,$]=(0,s.useState)(!1),[_,M]=(0,s.useState)(!1),[E,B]=(0,s.useState)({});(0,s.useEffect)(()=>{F(),z()},[e]);let F=async()=>{try{let t,s=await (t=e,a(`/api/l1-writing/${t}`));if(s.sections){let e={...c};Object.entries(s.sections).forEach(([t,s])=>{t in e&&(e[t]={content:s.text,citations:s.citations.map(e=>({...e,document_id:"",page_number:1})),status:s.text?"draft":"empty"})}),x(e)}}catch(e){console.error("Failed to load existing writing:",e)}},z=async()=>{try{let t,s=await (t=e,a(`/api/citation-index/${t}`)),r={};Object.entries(s.citations).forEach(([e,t])=>{if(t.quotes&&t.quotes.length>0){let s=t.quotes[0];r[e]={exhibit:e,file_name:t.file_name,quote:s.text,claim:"",document_id:t.document_id,page_number:s.page,bbox:s.bbox}}}),B(r)}catch(e){console.error("Failed to load citation index:",e)}},W=(0,s.useCallback)(e=>{x(t=>({...t,[o]:{...t[o],content:e,status:e?"draft":"empty"}}))},[o]),P=(0,s.useCallback)(e=>{b(e)},[]),A=(0,s.useCallback)(()=>{"bubble"===v&&j("right")},[v]),T=async(t,s)=>{if(!t.trim())return;L(!0);let l={id:`msg-${Date.now()}`,role:"user",content:t,selection:s||void 0,timestamp:new Date().toISOString()};h(e=>[...e,l]);try{let n,l,d,x,u,m=c[o].content,p=await (n=e,l=o,d=m,x=t,u=s||void 0,a(`/api/l1-revise/${n}`,{method:"POST",body:JSON.stringify({section_type:l,current_content:d,instruction:x,selection:u||null})}));W(p.revised_content);let g={id:`msg-${Date.now()}-response`,role:"assistant",content:p.changes_made||"Changes applied successfully.",timestamp:new Date().toISOString()};h(e=>[...e,g]),b(null),window.getSelection()?.removeAllRanges(),r?.(i.writing.contentUpdated)}catch(t){console.error("Failed to apply changes:",t),n?.(i.writing.applyFailed);let e={id:`msg-${Date.now()}-error`,role:"assistant",content:"Sorry, I encountered an error. Please try again.",timestamp:new Date().toISOString()};h(t=>[...t,e])}finally{L(!1)}},O=async()=>{$(!0);try{let t,s,n=await (t=e,s=o,a(`/api/l1-write/${t}?section_type=${s}`,{method:"POST"}));if(n.paragraph){W(n.paragraph.text);let e=n.paragraph.citations.map(e=>{let t=E[e.exhibit];return{...e,document_id:t?.document_id||"",page_number:t?.page_number||1,bbox:t?.bbox}});x(t=>({...t,[o]:{...t[o],citations:e}})),r?.(i.writing.paragraphGenerated)}}catch(e){console.error("Failed to generate paragraph:",e),n?.(i.writing.generateFailed)}finally{$(!1)}},R=async()=>{M(!0);try{let t,s,n,l,d=c[o];await (t=e,s=o,n=d.content,l=d.citations,a(`/api/l1-write-manual/${t}`,{method:"POST",body:JSON.stringify({section_type:s,paragraph_text:n,citations_used:l})})),x(e=>({...e,[o]:{...e[o],status:"complete"}})),r?.(i.writing.contentSaved)}catch(e){console.error("Failed to save:",e),n?.(i.writing.saveFailed)}finally{M(!1)}},D=c[o],H=Object.fromEntries(Object.entries(c).map(([e,t])=>[e,t.status]));return(0,t.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden",children:[(0,t.jsxs)("div",{className:"px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600",children:(0,t.jsx)(eP,{})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-semibold text-gray-900",children:i.writing.title}),(0,t.jsx)("p",{className:"text-xs text-gray-500",children:i.writing.subtitle})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("button",{onClick:()=>k(!w),className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",title:i.writing.dialogPosition,children:(0,t.jsx)(eO,{})}),(0,t.jsxs)("button",{onClick:O,disabled:S||!l,className:"flex items-center gap-2 px-3 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors",children:[S?(0,t.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):(0,t.jsx)(eT,{}),i.writing.generate]}),(0,t.jsxs)("button",{onClick:R,disabled:_||!D.content,className:"flex items-center gap-2 px-3 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors",children:[_?(0,t.jsxs)("svg",{className:"w-4 h-4 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}):(0,t.jsx)(eA,{}),i.writing.save]})]})]}),w&&(0,t.jsxs)("div",{className:"px-6 py-3 border-b border-gray-200 bg-gray-50 flex items-center gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("span",{className:"text-sm text-gray-600",children:[i.writing.dialogPosition,":"]}),(0,t.jsxs)("select",{value:f,onChange:e=>j(e.target.value),className:"text-sm border border-gray-300 rounded px-2 py-1",children:[(0,t.jsx)("option",{value:"bottom",children:i.writing.bottom}),(0,t.jsx)("option",{value:"right",children:i.writing.rightPanel})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("span",{className:"text-sm text-gray-600",children:[i.writing.selectionEdit,":"]}),(0,t.jsxs)("select",{value:v,onChange:e=>N(e.target.value),className:"text-sm border border-gray-300 rounded px-2 py-1",children:[(0,t.jsx)("option",{value:"bubble",children:i.writing.floatingBubble}),(0,t.jsx)("option",{value:"panel",children:i.writing.sidePanel})]})]})]}),(0,t.jsx)(eS,{activeSection:o,onSectionChange:d,sectionStatus:H}),(0,t.jsxs)("div",{className:`flex ${"right"===f?"flex-row":"flex-col"}`,children:[(0,t.jsx)("div",{className:"flex-1 min-h-[400px] border-b border-gray-200",children:(0,t.jsx)(eE,{content:D.content,onChange:W,citations:D.citations,onSelectionChange:P,selectionEditMode:v,onEditSelection:A})}),(0,t.jsx)(ez,{mode:f,selection:y,onSend:T,onShowHistory:()=>g(!0),isProcessing:C,recentMessages:u.slice(-3)})]}),(0,t.jsx)(eW,{isOpen:p,onClose:()=>g(!1),history:u}),!l&&(0,t.jsx)("div",{className:"px-6 py-3 bg-amber-50 border-t border-amber-200 text-sm text-amber-700",children:i.writing.modelsLoading})]})}function eD({className:e=""}){let{locale:s,setLocale:r}=(0,m.useLanguage)();return(0,t.jsxs)("button",{onClick:()=>{r("zh"===s?"en":"zh")},className:`flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg
        bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors ${e}`,title:"zh"===s?"Switch to English":"切换到中文",children:[(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"})}),(0,t.jsx)("span",{children:"zh"===s?"EN":"中文"})]})}let eH=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})}),eq=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),eV=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),eI=()=>(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),eJ=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),eU=()=>(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})});function eQ({message:e,type:r,onClose:a}){return(0,s.useEffect)(()=>{let e=setTimeout(a,3e3);return()=>clearTimeout(e)},[a]),(0,t.jsxs)("div",{className:`fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg ${"success"===r?"bg-green-500":"error"===r?"bg-red-500":"bg-blue-500"} text-white flex items-center gap-3 animate-slide-in z-50`,children:[(0,t.jsx)("span",{children:e}),(0,t.jsx)("button",{onClick:a,className:"text-white/80 hover:text-white",children:(0,t.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}function eK(){let{t:e}=(0,m.useLanguage)(),[r,n]=(0,s.useState)(!1),[l,i]=(0,s.useState)([]),[o,d]=(0,s.useState)(null),[c,x]=(0,s.useState)(!0),[u,p]=(0,s.useState)(!1),[g,y]=(0,s.useState)(!1),[b,f]=(0,s.useState)(""),[j,v]=(0,s.useState)([]),[w,k]=(0,s.useState)(!1),[C,L]=(0,s.useState)("checking"),[S,$]=(0,s.useState)(null),_=(0,s.useCallback)(async()=>{try{let e=await fetch("https://petigen.zacchen.win/");L(e.ok?"online":"offline")}catch{L("offline")}},[]),{data:E}=h({fetcher:()=>a("/api/preload-status"),shouldContinue:e=>e.is_loading&&!e.is_ready,interval:2e3,errorRetryInterval:5e3,maxErrorCount:5,enabled:!0,onError:e=>{console.error("Failed to get preload status:",e)}});(0,s.useEffect)(()=>{console.log(`%cPetitionLetter Frontend v0.2.0%c
Build: 02/02/2026, 06:03 (New York Time)`,"color: #2563EB; font-size: 14px; font-weight: bold;","color: #64748B; font-size: 12px;"),B(),_()},[_]),(0,s.useEffect)(()=>{o?P():v([])},[o]);let B=async()=>{try{x(!0);let e=await a("/api/projects");i(e||[]),e&&e.length>0&&!o&&d(e[0])}catch(t){console.error("Failed to load projects:",t),A(e.project.loadFailed,"error")}finally{x(!1)}},F=async()=>{try{let t;p(!0);let s=await (t=`Project ${l.length+1}`,a("/api/projects",{method:"POST",body:JSON.stringify({name:t})}));i(e=>[s,...e]),d(s),v([]),A(e.project.projectCreated,"success")}catch(t){console.error("Failed to create project:",t),A(e.project.createFailed,"error")}finally{p(!1)}},z=async t=>{if(confirm(e.project.deleteConfirm))try{let s;await (s=t,a(`/api/projects/${s}`,{method:"DELETE"})),i(e=>e.filter(e=>e.id!==t)),o?.id===t&&d(l.find(e=>e.id!==t)||null),A(e.project.projectDeleted,"success")}catch(t){console.error("Failed to delete project:",t),A(e.project.deleteFailed,"error")}},W=async()=>{if(!o||!b.trim())return void y(!1);let t=b.trim();if(t===o.name)return void y(!1);try{let s,r,n=await (s=o.id,r={name:t},a(`/api/projects/${s}`,{method:"PATCH",body:JSON.stringify(r)}));d(n),i(e=>e.map(e=>e.id===o.id?n:e)),A(e.project.projectRenamed,"success")}catch(t){console.error("Failed to rename project:",t),A(e.project.renameFailed,"error")}finally{y(!1)}},P=async()=>{if(o)try{let e;k(!0);let t=await (e=o.id,a(`/api/documents/${e}`));v(t.documents||[])}catch(e){console.error("Failed to load documents:",e)}finally{k(!1)}},A=(e,t)=>{$({message:e,type:t})},T=async()=>{await new Promise(e=>setTimeout(e,500)),await P()},O=e=>{A(e,"success")},R=e=>{A(e,"error")};return(0,t.jsxs)("div",{className:"flex h-screen overflow-hidden bg-gray-50",children:[(0,t.jsxs)("aside",{className:`bg-white border-r border-gray-200 flex flex-col transition-all duration-300 ${r?"w-16":"w-72"}`,children:[(0,t.jsxs)("div",{className:"h-16 flex items-center justify-between px-4 border-b border-gray-200",children:[!r&&(0,t.jsx)("h1",{className:"font-semibold text-gray-900 truncate",children:"PetitionLetter"}),(0,t.jsx)("button",{onClick:()=>n(!r),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:r?(0,t.jsx)(eI,{}):(0,t.jsx)(eV,{})})]}),(0,t.jsx)("div",{className:"p-3",children:(0,t.jsxs)("button",{onClick:F,disabled:u,className:`w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 ${r?"px-2":""}`,children:[(0,t.jsx)(eq,{}),!r&&(0,t.jsx)("span",{children:e.project.newProject})]})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto px-3 pb-3",children:c?(0,t.jsx)("div",{className:"space-y-2",children:[1,2,3].map(e=>(0,t.jsx)("div",{className:"h-12 bg-gray-100 rounded-lg animate-pulse"},e))}):0===l.length?!r&&(0,t.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:e.project.noProjects}):(0,t.jsx)("div",{className:"space-y-1",children:l.map(e=>(0,t.jsxs)("div",{className:`group flex items-center gap-2 rounded-lg transition-colors ${o?.id===e.id?"bg-blue-50 text-blue-600":"hover:bg-gray-100 text-gray-700"}`,children:[(0,t.jsxs)("button",{onClick:()=>d(e),className:"flex-1 flex items-center gap-3 px-3 py-2.5 text-left",children:[(0,t.jsx)(eH,{}),!r&&(0,t.jsx)("span",{className:"truncate text-sm font-medium",children:e.name})]}),!r&&(0,t.jsx)("button",{onClick:t=>{t.stopPropagation(),z(e.id)},className:"p-1.5 mr-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all",children:(0,t.jsx)(eU,{})})]},e.id))})}),(0,t.jsx)("div",{className:"p-3 border-t border-gray-200",children:(0,t.jsxs)("div",{className:`flex items-center gap-2 ${r?"justify-center":""}`,children:[(0,t.jsx)("span",{className:`w-2 h-2 rounded-full ${"online"===C?"bg-green-500":"offline"===C?"bg-red-500":"bg-yellow-500 animate-pulse"}`}),!r&&(0,t.jsx)("span",{className:"text-xs text-gray-500",children:"online"===C?e.backend.connected:"offline"===C?e.backend.disconnected:e.backend.checking})]})})]}),(0,t.jsxs)("main",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,t.jsxs)("header",{className:"h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 flex-shrink-0",children:[(0,t.jsxs)("div",{children:[g?(0,t.jsx)("input",{type:"text",value:b,onChange:e=>f(e.target.value),onBlur:W,onKeyDown:e=>{"Enter"===e.key&&W(),"Escape"===e.key&&y(!1)},autoFocus:!0,className:"font-semibold text-gray-900 bg-gray-100 px-2 py-1 rounded border border-gray-300 focus:outline-none focus:border-blue-500"}):(0,t.jsx)("h2",{className:`font-semibold text-gray-900 ${o?"cursor-pointer hover:text-blue-600":""}`,onClick:o?()=>{o&&(f(o.name),y(!0))}:void 0,title:o?e.project.clickToRename:void 0,children:o?.name||e.project.selectProject}),o&&(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:[j.length," ",e.project.documents]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(eD,{}),o&&(0,t.jsxs)("button",{onClick:P,disabled:w,className:"flex items-center gap-2 px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50",children:[(0,t.jsx)(eJ,{}),e.common.refresh]})]})]}),(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-6",children:[E&&!E.is_ready&&(0,t.jsx)("div",{className:"max-w-4xl mx-auto mb-4",children:(0,t.jsx)("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center",children:(0,t.jsxs)("svg",{className:"w-5 h-5 text-amber-600 animate-spin",fill:"none",viewBox:"0 0 24 24",children:[(0,t.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,t.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-amber-800",children:e.backend.modelsLoading}),(0,t.jsxs)("div",{className:"flex gap-4 mt-1 text-xs text-amber-600",children:[(0,t.jsxs)("span",{children:["OCR: ","loaded"===E.models.ocr.status?`✓ ${e.backend.modelLoaded}`:"loading"===E.models.ocr.status?`${e.backend.modelLoading} ${E.models.ocr.progress}%`:"error"===E.models.ocr.status?`✗ ${e.backend.modelError}`:e.backend.modelWaiting]}),(0,t.jsxs)("span",{children:["LLM: ","loaded"===E.models.llm.status?`✓ ${e.backend.modelLoaded}`:"loading"===E.models.llm.status?`${e.backend.modelLoading} ${E.models.llm.progress}%`:"error"===E.models.llm.status?`✗ ${e.backend.modelError}`:e.backend.modelWaiting]})]})]})]})})}),o?(0,t.jsxs)("div",{className:"max-w-4xl mx-auto space-y-6",children:[(0,t.jsx)(N,{projectId:o.id,documents:j,onUploadComplete:T,onSuccess:O,onError:R}),(0,t.jsx)(M,{projectId:o.id,documents:j,onOCRComplete:()=>{P()},onSuccess:O,onError:R,modelsReady:E?.models?.ocr?.status==="loaded"}),(0,t.jsx)(V,{projectId:o.id,documents:j,onHighlightComplete:()=>{},onSuccess:O,onError:R,modelsReady:E?.models?.llm?.status==="loaded"}),(0,t.jsx)(Z,{projectId:o.id,onSuccess:O,onError:R}),(0,t.jsx)(ew,{projectId:o.id,onSuccess:O,onError:R}),(0,t.jsx)(eR,{projectId:o.id,onSuccess:O,onError:R,modelsReady:E?.models?.llm?.status==="loaded"})]}):(0,t.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 mx-auto mb-4",children:(0,t.jsx)(eH,{})}),(0,t.jsx)("p",{className:"text-lg font-medium text-gray-900",children:e.project.selectProject}),(0,t.jsx)("p",{className:"text-gray-500 mt-2",children:e.project.createFirst}),(0,t.jsx)("button",{onClick:F,className:"mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:e.project.newProject})]})})]})]}),S&&(0,t.jsx)(eQ,{message:S.message,type:S.type,onClose:()=>$(null)})]})}e.s(["default",()=>eK],52683)}]);